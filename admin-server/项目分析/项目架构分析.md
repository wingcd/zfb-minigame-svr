# 小游戏管理后台项目架构分析

## 1. 项目概述

本项目是一个基于阿里云小程序云函数构建的小游戏管理后台系统，提供多应用管理、用户管理、排行榜、游戏配置、邮件系统等核心功能。

### 1.1 技术栈
- **后端**: 阿里云小程序云函数 (@alipay/faas-server-sdk)
- **数据库**: 阿里云数据库
- **前端**: 小程序端 (miniprogram目录)
- **认证**: 基于Token的JWT认证
- **日志**: 操作日志记录系统

### 1.2 项目结构
```
AdminServer/
├── cloud/functions/           # 云函数目录
│   ├── common/               # 公共模块
│   ├── [各功能模块]/          # 具体功能云函数
├── miniprogram/             # 小程序前端
├── package.json            # 项目配置
└── README.md              # 项目说明
```

## 2. 核心功能模块

### 2.1 认证授权模块 (Authentication & Authorization)

**核心函数:**
- `adminLogin` - 管理员登录
- `login` - 玩家登录  
- `wx_login` - 微信登录
- `verifyToken` - Token验证
- `resetPassword` - 密码重置

**特性:**
- 基于Token的无状态认证
- 支持"记住我"功能(7天/30天过期)
- 完整的权限系统(基于角色和权限)
- 操作日志记录
- 登录失败保护

### 2.2 管理员管理模块 (Admin Management)

**核心函数:**
- `createAdmin` - 创建管理员
- `deleteAdmin` - 删除管理员  
- `updateAdmin` - 更新管理员信息
- `getAdminList` - 获取管理员列表
- `initAdmin` - 初始化管理员系统

**角色层级:**
- `super_admin` - 超级管理员(所有权限)
- `admin` - 管理员
- `operator` - 运营人员
- `viewer` - 查看者

**权限系统:**
- `admin_manage` - 管理员管理权限
- `app_manage` - 应用管理权限
- `role_manage` - 角色管理权限
- `stats_view` - 统计查看权限
- `leaderboard_manage` - 排行榜管理权限

### 2.3 应用管理模块 (Application Management)

**核心函数:**
- `createApp` - 创建应用
- `deleteApp` - 删除应用
- `updateApp` - 更新应用信息
- `getAllApps` - 获取应用列表
- `getAppDetail` - 获取应用详情
- `getAppStats` - 获取应用统计
- `queryApp` - 查询应用
- `appInit` - 应用初始化

**应用属性:**
- `appId` - 应用唯一标识
- `appName` - 应用名称
- `appSecret` - 应用密钥
- `channelAppKey` - 渠道密钥
- `category` - 应用分类
- `status` - 状态(active/inactive/pending)

**数据表设计:**
- `app_config` - 应用配置表
- `user_{appId}` - 每个应用独立的用户表

### 2.4 用户管理模块 (User Management)

**核心函数:**
- `getAllUsers` - 获取用户列表
- `getUserDetail` - 获取用户详情
- `setUserDetail` - 设置用户详情
- `saveUserInfo` - 保存用户信息
- `updateUserData` - 更新用户数据
- `deleteUser` - 删除用户
- `banUser` - 封禁用户
- `unbanUser` - 解封用户
- `getUserStats` - 获取用户统计
- `getUserGrowth` - 获取用户增长统计

**用户数据结构:**
- `openId` - 用户标识
- `playerId` - 玩家ID(自动生成)
- `token` - 登录凭证
- `data` - 用户游戏数据
- `banned` - 封禁状态
- `gmtCreate/gmtModify` - 创建/修改时间

### 2.5 排行榜系统 (Leaderboard System)

**核心函数:**
- `createLeaderboard` - 创建排行榜
- `deleteLeaderboard` - 删除排行榜
- `updateLeaderboard` - 更新排行榜
- `getAllLeaderboards` - 获取排行榜列表
- `getLeaderboardData` - 获取排行榜数据
- `getLeaderboardStats` - 获取排行榜统计
- `getLeaderboardTopRank` - 获取排行榜头部排名
- `leaderboardInit` - 排行榜初始化
- `fixLeaderboardUserInfo` - 修复排行榜用户信息

**排行榜特性:**
- 支持多种重置类型(永久/日/周/月/自定义)
- 可配置排序规则(升序/降序)
- 支持多种更新策略(最高分/最新分/累计分)
- 自动排名计算
- 支持分数类型(更高更好/更低更好)

**分数管理:**
- `commitScore` - 提交分数
- `queryScore` - 查询分数
- `updateScore` - 更新分数
- `deleteScore` - 删除分数

### 2.6 游戏配置系统 (Game Configuration)

**核心函数:**
- `createGameConfig` - 创建游戏配置
- `deleteGameConfig` - 删除游戏配置
- `updateGameConfig` - 更新游戏配置
- `getGameConfig` - 获取游戏配置
- `getGameConfigList` - 获取配置列表

**配置特性:**
- 支持版本化配置
- 支持全局和版本特定配置
- 多种配置类型(string/number/boolean/object/array)
- 配置激活状态管理

### 2.7 数据统计系统 (Statistics System)

**核心函数:**
- `getDashboardStats` - 获取仪表板统计
- `getRecentActivity` - 获取最近活动
- `getTopApps` - 获取热门应用

**统计维度:**
- 应用统计(总数/活跃数/新增数/用户数)
- 用户统计(总数/今日新增/今日活跃/封禁数)
- 活跃度统计(日活/周活/月活)
- 排行榜统计(总数/活跃数/分数记录数)

### 2.8 邮件系统 (Mail System)

**核心函数:**
- `createMail` - 创建邮件
- `deleteMail` - 删除邮件
- `updateMail` - 更新邮件
- `getAllMails` - 获取邮件列表
- `getUserMails` - 获取用户邮件
- `sendMail` - 发送邮件
- `updateMailStatus` - 更新邮件状态
- `getMailStats` - 获取邮件统计
- `initMailSystem` - 初始化邮件系统

**邮件特性:**
- 支持群发和单发
- 邮件状态管理
- 附件支持
- 邮件模板系统

### 2.9 计数器系统 (Counter System)

**核心函数:**
- `createCounter` - 创建计数器
- `deleteCounter` - 删除计数器
- `updateCounter` - 更新计数器
- `getCounter` - 获取计数器值
- `getCounterList` - 获取计数器列表
- `incrementCounter` - 计数器递增
- `getAllCounterStats` - 获取计数器统计

**计数器特性:**
- 原子性递增操作
- 支持自定义步长
- 计数器分类管理
- 实时统计

### 2.10 角色权限系统 (Role & Permission)

**核心函数:**
- `createRole` - 创建角色
- `deleteRole` - 删除角色
- `updateRole` - 更新角色
- `getAllRoles` - 获取角色列表
- `getRoleList` - 获取角色列表

**权限控制:**
- 基于角色的访问控制(RBAC)
- 权限装饰器模式
- Token验证中间件
- 操作日志记录

### 2.11 数据存储系统 (Data Storage)

**核心函数:**
- `saveData` - 保存数据
- `getData` - 获取数据

**存储特性:**
- JSON数据存储
- 自动备份
- 数据版本控制

### 2.12 通用工具模块 (Common Utilities)

**位置:** `common/index.js`

**工具函数:**
- `generateRandomString(length)` - 生成随机字符串
- `generateHash(data, algorithm)` - 生成哈希值
- `isEmpty(value)` - 验证参数是否为空
- `formatTime(date)` - 格式化时间

**认证模块:** `common/auth.js`
- `checkPermission(event, requiredPermissions)` - 权限校验
- `requirePermission(handler, requiredPermissions)` - 权限装饰器
- `logOperation(adminInfo, action, resource, details)` - 操作日志记录

## 3. 数据库设计

### 3.1 核心数据表

**管理员相关:**
- `admin_users` - 管理员用户表
- `admin_roles` - 管理员角色表
- `admin_operation_logs` - 管理员操作日志表

**应用相关:**
- `app_config` - 应用配置表
- `user_{appId}` - 用户表(每个应用独立)

**排行榜相关:**
- `leaderboard_config` - 排行榜配置表
- `leaderboard_score` - 排行榜分数表

**其他:**
- `game_config` - 游戏配置表
- `mail_system` - 邮件系统表
- `counter_system` - 计数器系统表

### 3.2 数据表关系

```
app_config (1:N) user_{appId}
app_config (1:N) leaderboard_config
app_config (1:N) game_config
admin_users (N:1) admin_roles
leaderboard_config (1:N) leaderboard_score
```

## 4. 安全特性

### 4.1 认证安全
- JWT Token认证
- Token过期机制
- 刷新Token支持
- 登录失败保护

### 4.2 权限安全
- 基于角色的访问控制
- 细粒度权限管理
- 操作日志审计
- 权限装饰器模式

### 4.3 数据安全
- 参数验证
- SQL注入防护
- 数据加密存储
- 访问日志记录

## 5. 性能优化

### 5.1 数据库优化
- 索引优化
- 分表设计(user_{appId})
- 查询条件优化
- 分页查询

### 5.2 缓存策略
- 统计数据缓存
- 配置数据缓存
- 用户会话缓存

### 5.3 并发处理
- 原子性操作
- 乐观锁机制
- 请求限流

## 6. 监控与运维

### 6.1 日志系统
- 操作日志记录
- 错误日志追踪
- 性能监控

### 6.2 统计分析
- 实时统计数据
- 用户行为分析
- 应用使用情况

### 6.3 健康检查
- 服务可用性监控
- 数据库连接监控
- 接口响应时间监控

## 7. 扩展性设计

### 7.1 模块化设计
- 功能模块独立
- 接口标准化
- 配置外部化

### 7.2 多租户支持
- 应用隔离
- 数据隔离
- 权限隔离

### 7.3 插件化架构
- 功能插件化
- 热插拔支持
- 配置驱动

## 8. 部署架构

### 8.1 云函数部署
- 按模块部署
- 自动缩放
- 负载均衡

### 8.2 数据库部署
- 主从复制
- 读写分离
- 备份策略

### 8.3 CDN加速
- 静态资源CDN
- 接口响应加速
- 全球节点部署
