# 游戏配置模块

## 1. 模块概述

游戏配置模块负责管理游戏中的各种配置参数，包括关卡配置、道具配置、系统配置等，支持热更新和版本控制。

### 1.1 主要功能
- 游戏配置管理
- 配置热更新
- 配置版本控制
- 配置模板管理
- 配置分环境部署

### 1.2 涉及云函数
- `getGameConfig` - 获取游戏配置
- `updateGameConfig` - 更新游戏配置
- `createGameConfig` - 创建游戏配置
- `deleteGameConfig` - 删除游戏配置
- `getConfigHistory` - 获取配置历史
- `rollbackConfig` - 回滚配置

---

## 2. 接口详情

### 2.1 获取游戏配置

#### getGameConfig
**功能**: 获取游戏配置信息  
**权限**: 无需权限（游戏客户端调用）

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| configType | string | 否 | 配置类型筛选 |
| version | string | 否 | 指定版本（默认：latest） |
| environment | string | 否 | 环境（dev/test/prod，默认：prod） |

**配置类型**:
- level: 关卡配置
- item: 道具配置
- system: 系统配置
- reward: 奖励配置
- shop: 商城配置

**输出结果**:
```json
{
    "code": 0,
    "msg": "success",
    "timestamp": 1603991234567,
    "data": {
        "version": "1.2.0",
        "lastUpdateTime": "2023-10-01T10:00:00.000Z",
        "configs": {
            "level": {
                "maxLevel": 100,
                "levelData": [
                    {
                        "level": 1,
                        "targetScore": 1000,
                        "moves": 30,
                        "obstacles": ["ice", "stone"],
                        "rewards": {
                            "coins": 100,
                            "exp": 50
                        }
                    }
                ]
            },
            "item": {
                "items": [
                    {
                        "itemId": "boost_bomb",
                        "name": "爆炸道具",
                        "description": "清除3x3范围内的方块",
                        "price": 100,
                        "category": "boost",
                        "maxStack": 99
                    }
                ]
            },
            "system": {
                "dailyRewardEnabled": true,
                "maxEnergy": 5,
                "energyRecoverTime": 1800,
                "friendMaxCount": 50
            }
        }
    }
}
```

---

### 2.2 更新游戏配置

#### updateGameConfig
**功能**: 更新游戏配置  
**权限**: 需要 config_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| configType | string | 是 | 配置类型 |
| configData | object | 是 | 配置数据 |
| version | string | 否 | 版本号（自动生成） |
| environment | string | 否 | 环境（默认：prod） |
| comment | string | 否 | 更新说明 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "更新成功",
    "timestamp": 1603991234567,
    "data": {
        "configId": "config_123456",
        "configType": "level",
        "version": "1.2.1",
        "environment": "prod",
        "updateTime": "2023-10-01T10:00:00.000Z",
        "operatorId": "admin_123",
        "comment": "增加新关卡50-60"
    }
}
```

**错误码**:
- 4001: 参数错误或配置格式无效
- 4003: 权限不足
- 4004: 应用不存在
- 5001: 服务器内部错误

---

### 2.3 创建游戏配置

#### createGameConfig
**功能**: 创建新的游戏配置  
**权限**: 需要 config_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| configType | string | 是 | 配置类型 |
| configName | string | 是 | 配置名称 |
| configData | object | 是 | 配置数据 |
| environment | string | 否 | 环境（默认：prod） |
| description | string | 否 | 配置描述 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "创建成功",
    "timestamp": 1603991234567,
    "data": {
        "configId": "config_123456",
        "configType": "level",
        "configName": "关卡配置",
        "version": "1.0.0",
        "environment": "prod",
        "createTime": "2023-10-01T10:00:00.000Z"
    }
}
```

---

### 2.4 删除游戏配置

#### deleteGameConfig
**功能**: 删除游戏配置  
**权限**: 需要 config_manage 权限（仅超级管理员）

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| configId | string | 是 | 配置ID |
| confirmDelete | boolean | 是 | 确认删除（必须为true） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "删除成功",
    "timestamp": 1603991234567,
    "data": {
        "deletedConfig": {
            "configId": "config_123456",
            "configType": "level",
            "configName": "关卡配置"
        },
        "warning": "配置已永久删除，相关历史版本也将清理"
    }
}
```

---

### 2.5 获取配置历史

#### getConfigHistory
**功能**: 获取配置变更历史  
**权限**: 需要 config_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| configType | string | 否 | 配置类型筛选 |
| environment | string | 否 | 环境筛选 |
| limit | number | 否 | 返回数量（默认：20） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "history": [
            {
                "historyId": "history_123456",
                "configType": "level",
                "version": "1.2.1",
                "environment": "prod",
                "operatorId": "admin_123",
                "operatorName": "系统管理员",
                "action": "update",
                "comment": "增加新关卡50-60",
                "updateTime": "2023-10-01T10:00:00.000Z",
                "changeSize": 1024
            }
        ],
        "total": 156
    }
}
```

---

### 2.6 回滚配置

#### rollbackConfig
**功能**: 回滚配置到指定版本  
**权限**: 需要 config_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| configType | string | 是 | 配置类型 |
| targetVersion | string | 是 | 目标版本 |
| environment | string | 否 | 环境（默认：prod） |
| reason | string | 是 | 回滚原因 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "回滚成功",
    "timestamp": 1603991234567,
    "data": {
        "configType": "level",
        "fromVersion": "1.2.1",
        "toVersion": "1.2.0",
        "rollbackTime": "2023-10-01T10:00:00.000Z",
        "operatorId": "admin_123",
        "reason": "新版本存在Bug，紧急回滚"
    }
}
```

---

## 3. 配置类型说明

### 3.1 关卡配置 (level)
- 关卡基础信息（目标分数、步数限制）
- 关卡布局和障碍物
- 关卡奖励配置
- 关卡解锁条件

### 3.2 道具配置 (item)
- 道具基础属性
- 道具效果和持续时间
- 道具获取方式
- 道具使用限制

### 3.3 系统配置 (system)
- 游戏基础参数
- 功能开关
- 限制和阈值
- 全局设置

### 3.4 奖励配置 (reward)
- 日常奖励
- 成就奖励
- 活动奖励
- 签到奖励

### 3.5 商城配置 (shop)
- 商品信息
- 价格配置
- 折扣活动
- 购买限制

---

## 4. 环境管理

### 4.1 环境类型
- **dev**: 开发环境（开发测试用）
- **test**: 测试环境（功能验证用）
- **prod**: 生产环境（正式发布用）

### 4.2 环境隔离
- 不同环境配置独立存储
- 支持配置在环境间复制
- 生产环境变更需要额外审批
- 测试环境可以模拟生产数据

---

## 5. 版本控制

### 5.1 版本命名规则
- 采用语义化版本号（major.minor.patch）
- 重大更新：major版本递增
- 功能更新：minor版本递增
- 修复更新：patch版本递增

### 5.2 版本管理特性
- 自动版本号生成
- 版本对比和差异查看
- 版本回滚功能
- 版本发布记录

---

## 6. 配置验证

### 6.1 格式验证
- JSON格式校验
- 数据类型验证
- 必填字段检查
- 数值范围验证

### 6.2 逻辑验证
- 配置依赖关系检查
- 业务规则验证
- 性能影响评估
- 兼容性检查

---

## 7. 数据存储说明

游戏配置模块的数据存储设计详见 `项目分析/数据库设计.md` 文档，主要涉及以下数据表：

- **game_config**: 游戏配置主表
- **game_config_history**: 游戏配置变更历史表
- **config_templates**: 配置模板表

这些表的详细结构、索引设计和关系说明请参考数据库设计文档。

---

## 8. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 参数错误/配置格式无效 |
| 4003 | 权限不足 |
| 4004 | 配置不存在/应用不存在 |
| 4005 | 配置版本冲突/环境不匹配 |
| 5001 | 服务器内部错误 |
