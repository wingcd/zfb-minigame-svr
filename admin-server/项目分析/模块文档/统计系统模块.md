# 统计系统模块

## 1. 模块概述

统计系统模块负责收集、分析和展示游戏运营数据，提供多维度的数据统计和可视化报表功能。

### 1.1 主要功能
- 用户行为统计
- 游戏数据分析
- 实时监控指标
- 自定义报表
- 数据导出功能

### 1.2 涉及云函数
- `getStatistics` - 获取统计数据
- `getDashboard` - 获取仪表盘数据
- `getReport` - 获取报表数据
- `exportData` - 导出数据
- `createCustomReport` - 创建自定义报表

---

## 2. 接口详情

### 2.1 获取统计数据

#### getStatistics
**功能**: 获取统计数据  
**权限**: 需要 data_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| metrics | array | 是 | 统计指标列表 |
| startDate | string | 是 | 开始日期（YYYY-MM-DD） |
| endDate | string | 是 | 结束日期（YYYY-MM-DD） |
| groupBy | string | 否 | 分组维度（day/week/month） |
| filters | object | 否 | 筛选条件 |

**统计指标类型**:
- user: 用户相关指标
- gameplay: 游戏相关指标
- revenue: 收入相关指标
- retention: 留存相关指标
- performance: 性能相关指标

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "appId": "game001",
        "period": {
            "startDate": "2023-09-01",
            "endDate": "2023-10-01",
            "groupBy": "day"
        },
        "summary": {
            "totalUsers": 12500,
            "newUsers": 2580,
            "activeUsers": 8950,
            "totalRevenue": 45600.50,
            "avgRetention": 68.5
        },
        "timeSeries": [
            {
                "date": "2023-10-01",
                "newUsers": 85,
                "activeUsers": 342,
                "gameplayCount": 856,
                "revenue": 1250.30,
                "avgSessionTime": 180
            }
        ],
        "distribution": {
            "userLevelDistribution": [
                {"level": "1-10", "count": 5600, "percentage": 44.8},
                {"level": "11-20", "count": 3200, "percentage": 25.6}
            ],
            "deviceDistribution": [
                {"device": "iPhone", "count": 7500, "percentage": 60.0},
                {"device": "Android", "count": 5000, "percentage": 40.0}
            ]
        }
    }
}
```

---

### 2.2 获取仪表盘数据

#### getDashboard
**功能**: 获取运营仪表盘数据  
**权限**: 需要 data_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| dashboardType | string | 否 | 仪表盘类型（overview/user/game/revenue） |
| timeRange | string | 否 | 时间范围（today/week/month，默认：today） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "dashboardType": "overview",
        "refreshTime": "2023-10-01T10:00:00.000Z",
        "realTimeMetrics": {
            "onlineUsers": 342,
            "todayNewUsers": 85,
            "todayRevenue": 1250.30,
            "gameplayCount": 856
        },
        "kpiCards": [
            {
                "title": "日活跃用户",
                "value": 8950,
                "change": "+5.2%",
                "changeType": "increase",
                "target": 10000
            },
            {
                "title": "新用户注册",
                "value": 85,
                "change": "-2.1%",
                "changeType": "decrease",
                "target": 100
            }
        ],
        "charts": [
            {
                "chartId": "user_trend",
                "title": "用户趋势",
                "type": "line",
                "data": [
                    {"date": "10-01", "value": 8950},
                    {"date": "09-30", "value": 8756}
                ]
            }
        ],
        "alerts": [
            {
                "type": "warning",
                "message": "新用户注册低于预期",
                "time": "2023-10-01T09:00:00.000Z"
            }
        ]
    }
}
```

---

### 2.3 获取报表数据

#### getReport
**功能**: 获取详细报表数据  
**权限**: 需要 data_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| reportType | string | 是 | 报表类型 |
| startDate | string | 是 | 开始日期 |
| endDate | string | 是 | 结束日期 |
| dimensions | array | 否 | 分析维度 |
| filters | object | 否 | 筛选条件 |

**报表类型**:
- user_analysis: 用户分析报表
- gameplay_analysis: 游戏行为分析
- retention_analysis: 留存分析
- revenue_analysis: 收入分析
- funnel_analysis: 漏斗分析

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "reportType": "user_analysis",
        "period": "2023-09-01 to 2023-10-01",
        "generatedTime": "2023-10-01T10:00:00.000Z",
        "summary": {
            "totalSamples": 12500,
            "analysisMetrics": 15,
            "keyFindings": [
                "新用户主要来源于微信分享",
                "游戏第3关流失率较高",
                "付费用户平均游戏时长更长"
            ]
        },
        "detailData": [
            {
                "dimension": "注册渠道",
                "data": [
                    {"channel": "微信分享", "users": 5600, "percentage": 44.8},
                    {"channel": "自然搜索", "users": 3200, "percentage": 25.6}
                ]
            }
        ],
        "recommendations": [
            "加强微信分享功能的用户体验",
            "优化第3关的难度设计",
            "针对付费用户推出更多精品内容"
        ]
    }
}
```

---

### 2.4 导出数据

#### exportData
**功能**: 导出统计数据  
**权限**: 需要 data_export 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| exportType | string | 是 | 导出类型 |
| startDate | string | 是 | 开始日期 |
| endDate | string | 是 | 结束日期 |
| format | string | 否 | 文件格式（csv/excel，默认：csv） |
| fields | array | 否 | 导出字段列表 |

**导出类型**:
- user_data: 用户数据
- gameplay_data: 游戏数据
- revenue_data: 收入数据
- custom_report: 自定义报表

**输出结果**:
```json
{
    "code": 0,
    "msg": "导出成功",
    "timestamp": 1603991234567,
    "data": {
        "taskId": "export_123456",
        "exportType": "user_data",
        "format": "csv",
        "estimatedTime": 300,
        "status": "processing",
        "downloadUrl": null,
        "createTime": "2023-10-01T10:00:00.000Z",
        "expireTime": "2023-10-08T10:00:00.000Z"
    }
}
```

---

### 2.5 创建自定义报表

#### createCustomReport
**功能**: 创建自定义报表模板  
**权限**: 需要 report_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| reportName | string | 是 | 报表名称 |
| description | string | 否 | 报表描述 |
| metrics | array | 是 | 统计指标 |
| dimensions | array | 是 | 分析维度 |
| filters | object | 否 | 默认筛选条件 |
| schedule | object | 否 | 定时生成配置 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "创建成功",
    "timestamp": 1603991234567,
    "data": {
        "reportId": "report_123456",
        "reportName": "用户留存分析",
        "status": "active",
        "createTime": "2023-10-01T10:00:00.000Z",
        "createdBy": "admin_123",
        "nextRunTime": "2023-10-02T00:00:00.000Z"
    }
}
```

---

## 3. 统计指标说明

### 3.1 用户指标 (User Metrics)
- **新增用户**: 新注册用户数量
- **活跃用户**: DAU/WAU/MAU
- **留存率**: 次日/7日/30日留存
- **用户生命周期**: 平均用户生命周期价值

### 3.2 游戏指标 (Gameplay Metrics)
- **游戏次数**: 总游戏局数
- **游戏时长**: 平均/总游戏时长
- **关卡通过率**: 各关卡通过情况
- **道具使用**: 道具使用频率和效果

### 3.3 收入指标 (Revenue Metrics)
- **总收入**: 累计收入金额
- **ARPU**: 平均每用户收入
- **ARPPU**: 平均每付费用户收入
- **付费率**: 付费用户占比

### 3.4 留存指标 (Retention Metrics)
- **次日留存**: 注册后第2天登录率
- **7日留存**: 注册后第7天登录率
- **30日留存**: 注册后第30天登录率
- **回访率**: 流失用户回访比例

---

## 4. 数据收集机制

### 4.1 实时数据收集
- 用户行为事件埋点
- 游戏状态变化监控
- 系统性能指标采集
- 错误和异常日志

### 4.2 数据处理流程
1. 原始数据收集
2. 数据清洗和验证
3. 实时指标计算
4. 数据聚合和存储
5. 报表生成和展示

---

## 5. 数据存储说明

统计系统模块的数据存储设计详见 `项目分析/数据库设计.md` 文档，主要涉及以下数据表：

- **statistics_daily**: 日统计数据汇总表
- **statistics_events**: 事件原始数据表  
- **custom_reports**: 自定义报表配置表
- **export_tasks**: 数据导出任务表

这些表的详细结构、索引设计和关系说明请参考数据库设计文档。

---

## 6. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 参数错误/日期格式无效 |
| 4003 | 权限不足 |
| 4004 | 应用不存在/报表不存在 |
| 4005 | 数据导出任务已存在 |
| 5001 | 服务器内部错误 |
