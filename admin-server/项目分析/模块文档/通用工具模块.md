# 通用工具模块

## 1. 模块概述

通用工具模块提供项目中常用的工具函数和服务，包括文件上传、数据验证、时间处理、加密解密等基础功能。

### 1.1 主要功能
- 文件上传下载
- 数据格式验证
- 加密解密服务
- 时间日期处理
- 随机数生成
- 数据转换工具

### 1.2 涉及云函数
- `uploadFile` - 文件上传
- `generateId` - 生成唯一ID
- `validateData` - 数据验证
- `encryptData` - 数据加密
- `decryptData` - 数据解密
- `formatDate` - 日期格式化

---

## 2. 接口详情

### 2.1 文件上传

#### uploadFile
**功能**: 上传文件到云存储  
**权限**: 需要用户登录Token

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| token | string | 是 | 用户Token |
| fileType | string | 是 | 文件类型 |
| fileData | string | 是 | 文件数据（Base64编码） |
| fileName | string | 否 | 文件名称 |
| folder | string | 否 | 存储文件夹 |

**文件类型**:
- avatar: 头像图片
- screenshot: 游戏截图
- document: 文档文件
- config: 配置文件

**输出结果**:
```json
{
    "code": 0,
    "msg": "上传成功",
    "timestamp": 1603991234567,
    "data": {
        "fileId": "file_123456",
        "fileName": "avatar.png",
        "fileType": "avatar",
        "fileSize": 2048576,
        "fileUrl": "https://cloud.tencent.com/storage/file_123456.png",
        "thumbnailUrl": "https://cloud.tencent.com/storage/thumb_file_123456.png",
        "uploadTime": "2023-10-01T10:00:00.000Z",
        "expireTime": "2024-10-01T10:00:00.000Z",
        "metadata": {
            "width": 200,
            "height": 200,
            "format": "PNG"
        }
    }
}
```

---

### 2.2 生成唯一ID

#### generateId
**功能**: 生成各种类型的唯一标识符  
**权限**: 无需权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| idType | string | 是 | ID类型 |
| prefix | string | 否 | ID前缀 |
| length | number | 否 | ID长度 |

**ID类型**:
- uuid: 标准UUID
- snowflake: 雪花算法ID
- random: 随机字符串
- timestamp: 时间戳ID
- custom: 自定义格式

**输出结果**:
```json
{
    "code": 0,
    "msg": "生成成功",
    "timestamp": 1603991234567,
    "data": {
        "idType": "snowflake",
        "generatedId": "1679123456789012345",
        "prefix": "player",
        "fullId": "player_1679123456789012345",
        "generateTime": "2023-10-01T10:00:00.000Z",
        "metadata": {
            "machineId": "001",
            "sequence": "123"
        }
    }
}
```

---

### 2.3 数据验证

#### validateData
**功能**: 验证数据格式和内容  
**权限**: 无需权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| dataType | string | 是 | 数据类型 |
| data | mixed | 是 | 待验证数据 |
| rules | object | 否 | 验证规则 |
| strict | boolean | 否 | 严格模式（默认：false） |

**数据类型**:
- email: 邮箱地址
- phone: 手机号码
- idcard: 身份证号
- url: URL地址
- json: JSON格式
- custom: 自定义规则

**输出结果**:
```json
{
    "code": 0,
    "msg": "验证成功",
    "timestamp": 1603991234567,
    "data": {
        "dataType": "email",
        "valid": true,
        "normalizedData": "user@example.com",
        "validationDetails": {
            "format": "valid",
            "domain": "example.com",
            "provider": "unknown"
        },
        "suggestions": [],
        "errors": []
    }
}
```

**验证失败示例**:
```json
{
    "code": 4001,
    "msg": "验证失败",
    "timestamp": 1603991234567,
    "data": {
        "dataType": "email",
        "valid": false,
        "errors": [
            {
                "field": "email",
                "rule": "format",
                "message": "邮箱格式不正确"
            }
        ],
        "suggestions": [
            "请检查邮箱格式，确保包含@符号"
        ]
    }
}
```

---

### 2.4 数据加密

#### encryptData
**功能**: 加密敏感数据  
**权限**: 需要 data_encrypt 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| data | string | 是 | 待加密数据 |
| algorithm | string | 否 | 加密算法（默认：AES256） |
| key | string | 否 | 加密密钥（不提供则使用默认） |
| mode | string | 否 | 加密模式（CBC/ECB/GCM） |

**加密算法**:
- AES128: AES 128位加密
- AES256: AES 256位加密
- RSA: RSA非对称加密
- DES: DES加密（不推荐）

**输出结果**:
```json
{
    "code": 0,
    "msg": "加密成功",
    "timestamp": 1603991234567,
    "data": {
        "algorithm": "AES256",
        "mode": "CBC",
        "encryptedData": "U2FsdGVkX19...",
        "keyId": "key_001",
        "iv": "1234567890abcdef",
        "encryptTime": "2023-10-01T10:00:00.000Z",
        "dataHash": "sha256:abc123..."
    }
}
```

---

### 2.5 数据解密

#### decryptData
**功能**: 解密已加密数据  
**权限**: 需要 data_decrypt 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| encryptedData | string | 是 | 加密数据 |
| algorithm | string | 是 | 加密算法 |
| key | string | 否 | 解密密钥 |
| iv | string | 否 | 初始化向量 |
| keyId | string | 否 | 密钥ID |

**输出结果**:
```json
{
    "code": 0,
    "msg": "解密成功",
    "timestamp": 1603991234567,
    "data": {
        "decryptedData": "original_data_content",
        "algorithm": "AES256",
        "dataLength": 1024,
        "decryptTime": "2023-10-01T10:00:00.000Z",
        "verificationPassed": true
    }
}
```

---

### 2.6 日期格式化

#### formatDate
**功能**: 格式化日期时间  
**权限**: 无需权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| timestamp | number | 是 | 时间戳（毫秒） |
| format | string | 否 | 格式模板（默认：YYYY-MM-DD HH:mm:ss） |
| timezone | string | 否 | 时区（默认：Asia/Shanghai） |
| locale | string | 否 | 语言地区（默认：zh-CN） |

**格式模板**:
- YYYY-MM-DD: 2023-10-01
- HH:mm:ss: 10:30:45
- YYYY-MM-DD HH:mm:ss: 2023-10-01 10:30:45
- custom: 自定义格式

**输出结果**:
```json
{
    "code": 0,
    "msg": "格式化成功",
    "timestamp": 1603991234567,
    "data": {
        "originalTimestamp": 1696147845000,
        "formattedDate": "2023-10-01 10:30:45",
        "format": "YYYY-MM-DD HH:mm:ss",
        "timezone": "Asia/Shanghai",
        "locale": "zh-CN",
        "weekday": "星期日",
        "relative": "2天前",
        "iso8601": "2023-10-01T10:30:45.000+08:00"
    }
}
```

---

## 3. 工具类别说明

### 3.1 文件处理工具
- 文件上传下载
- 图片压缩处理
- 文件格式转换
- 文件安全检查

### 3.2 数据验证工具
- 格式验证
- 业务规则验证
- 数据完整性检查
- 安全性验证

### 3.3 加密解密工具
- 对称加密
- 非对称加密
- 哈希算法
- 数字签名

### 3.4 时间处理工具
- 时间格式化
- 时区转换
- 时间计算
- 相对时间

### 3.5 ID生成工具
- UUID生成
- 雪花算法
- 自定义规则
- 序列号管理

---

## 4. 使用示例

### 4.1 头像上传流程
```javascript
// 1. 上传头像文件
const uploadResult = await uploadFile({
    appId: "game001",
    token: "user_token",
    fileType: "avatar",
    fileData: "base64_image_data",
    fileName: "avatar.png"
});

// 2. 更新用户头像URL
const updateResult = await updateUserInfo({
    appId: "game001",
    token: "user_token",
    avatar: uploadResult.data.fileUrl
});
```

### 4.2 数据验证流程
```javascript
// 验证邮箱格式
const emailValidation = await validateData({
    dataType: "email",
    data: "user@example.com",
    strict: true
});

if (emailValidation.data.valid) {
    // 邮箱格式正确，继续处理
} else {
    // 显示验证错误信息
}
```

### 4.3 敏感数据加密
```javascript
// 加密用户密码
const encryptResult = await encryptData({
    data: "user_password",
    algorithm: "AES256"
});

// 存储加密后的密码
const storeResult = await storeUserPassword({
    playerId: "player_001",
    encryptedPassword: encryptResult.data.encryptedData,
    keyId: encryptResult.data.keyId
});
```

---

## 5. 配置管理

### 5.1 文件上传配置
- 允许的文件类型
- 文件大小限制
- 存储路径规则
- 访问权限设置

### 5.2 加密配置
- 默认加密算法
- 密钥管理策略
- 密钥轮换周期
- 加密强度设置

### 5.3 验证规则配置
- 数据格式规则
- 业务验证规则
- 错误提示信息
- 多语言支持

---

## 6. 安全考虑

### 6.1 文件安全
- 文件类型白名单
- 文件内容扫描
- 病毒检测
- 访问权限控制

### 6.2 数据安全
- 敏感数据加密
- 传输加密
- 存储加密
- 访问日志记录

### 6.3 密钥安全
- 密钥分离存储
- 定期密钥轮换
- 密钥访问控制
- 密钥使用审计

---

## 7. 数据存储说明

通用工具模块的数据存储设计详见 `项目分析/数据库设计.md` 文档，主要涉及以下数据表：

- **file_info**: 文件信息表
- **encryption_keys**: 加密密钥表
- **validation_rules**: 验证规则表
- **operation_logs**: 操作日志表

这些表的详细结构、索引设计和关系说明请参考数据库设计文档。

---

## 8. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 参数错误/数据格式无效 |
| 4003 | 权限不足 |
| 4004 | 文件不存在/密钥不存在 |
| 4005 | 文件过大/格式不支持 |
| 4006 | 加密失败/解密失败 |
| 5001 | 服务器内部错误 |
