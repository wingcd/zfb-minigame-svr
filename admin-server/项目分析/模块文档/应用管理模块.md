# 应用管理模块

## 1. 模块概述

应用管理模块负责小程序/游戏应用的注册、配置、状态管理以及应用相关的基础数据管理。

### 1.1 主要功能
- 应用注册与配置
- 应用状态管理
- 应用信息查询
- 应用数据统计

### 1.2 涉及云函数
- `createApp` - 创建应用
- `updateApp` - 更新应用
- `getAppList` - 获取应用列表
- `getAppInfo` - 获取应用详情
- `deleteApp` - 删除应用
- `getAppStats` - 获取应用统计

---

## 2. 接口详情

### 2.1 创建应用

#### createApp
**功能**: 注册新应用  
**权限**: 需要 app_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID（唯一标识） |
| appName | string | 是 | 应用名称 |
| appType | string | 是 | 应用类型（game/miniprogram） |
| description | string | 否 | 应用描述 |
| developer | string | 否 | 开发者 |
| contact | string | 否 | 联系方式 |
| version | string | 否 | 版本号（默认：1.0.0） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "创建成功",
    "timestamp": 1603991234567,
    "data": {
        "appId": "game001",
        "appName": "消除小游戏",
        "appType": "game",
        "status": "active",
        "createTime": "2023-10-01T10:00:00.000Z",
        "apiKey": "ak_abc123def456",
        "secretKey": "sk_xyz789uvw456"
    }
}
```

**错误码**:
- 4001: 参数错误或无效应用类型
- 4002: 应用ID已存在
- 4003: 权限不足
- 5001: 服务器内部错误

---

### 2.2 更新应用

#### updateApp
**功能**: 更新应用信息  
**权限**: 需要 app_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| appName | string | 否 | 应用名称 |
| description | string | 否 | 应用描述 |
| developer | string | 否 | 开发者 |
| contact | string | 否 | 联系方式 |
| version | string | 否 | 版本号 |
| status | string | 否 | 状态（active/disabled/maintenance） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "更新成功",
    "timestamp": 1603991234567,
    "data": {
        "appId": "game001",
        "appName": "消除小游戏v2",
        "status": "active",
        "updateTime": "2023-10-01T10:00:00.000Z"
    }
}
```

**错误码**:
- 4001: 参数错误
- 4003: 权限不足
- 4004: 应用不存在

---

### 2.3 获取应用列表

#### getAppList
**功能**: 获取应用列表  
**权限**: 需要 app_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| page | number | 否 | 页码（默认：1） |
| limit | number | 否 | 每页数量（默认：20） |
| appType | string | 否 | 应用类型筛选 |
| status | string | 否 | 状态筛选 |
| keyword | string | 否 | 关键词搜索（应用名称/ID） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "list": [
            {
                "appId": "game001",
                "appName": "消除小游戏",
                "appType": "game",
                "status": "active",
                "userCount": 1250,
                "todayActiveUser": 85,
                "version": "1.2.0",
                "developer": "游戏工作室",
                "createTime": "2023-09-15T10:00:00.000Z",
                "updateTime": "2023-10-01T08:30:00.000Z"
            }
        ],
        "total": 12,
        "page": 1,
        "limit": 20,
        "totalPages": 1
    }
}
```

---

### 2.4 获取应用详情

#### getAppInfo
**功能**: 获取应用详细信息  
**权限**: 需要 app_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "appInfo": {
            "appId": "game001",
            "appName": "消除小游戏",
            "appType": "game",
            "description": "一款休闲消除类小游戏",
            "status": "active",
            "version": "1.2.0",
            "developer": "游戏工作室",
            "contact": "dev@game.com",
            "createTime": "2023-09-15T10:00:00.000Z",
            "updateTime": "2023-10-01T08:30:00.000Z",
            "apiKey": "ak_abc123def456"
        },
        "statistics": {
            "userCount": 1250,
            "todayActiveUser": 85,
            "todayNewUser": 12,
            "todayLoginCount": 156,
            "gameplayCount": 342,
            "lastActiveTime": "2023-10-01T09:45:00.000Z"
        },
        "configuration": {
            "maxLevel": 100,
            "enableLeaderboard": true,
            "enableMail": true,
            "maintainanceMode": false
        }
    }
}
```

---

### 2.5 删除应用

#### deleteApp
**功能**: 删除应用  
**权限**: 需要 app_manage 权限（仅超级管理员）

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| confirmDelete | boolean | 是 | 确认删除（必须为true） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "删除成功",
    "timestamp": 1603991234567,
    "data": {
        "deletedApp": {
            "appId": "game001",
            "appName": "消除小游戏",
            "userCount": 1250
        },
        "warning": "应用数据已永久删除，包括所有用户数据"
    }
}
```

**错误码**:
- 4001: 参数错误或未确认删除
- 4003: 权限不足（仅超级管理员可删除）
- 4004: 应用不存在

---

### 2.6 获取应用统计

#### getAppStats
**功能**: 获取应用统计数据  
**权限**: 需要 data_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| startDate | string | 否 | 开始日期（YYYY-MM-DD） |
| endDate | string | 否 | 结束日期（YYYY-MM-DD） |
| metrics | array | 否 | 指标类型（默认：全部） |

**指标类型**:
- user: 用户相关
- login: 登录相关
- gameplay: 游戏相关
- revenue: 收入相关（如果有）

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "appId": "game001",
        "period": {
            "startDate": "2023-09-01",
            "endDate": "2023-10-01"
        },
        "userMetrics": {
            "totalUsers": 1250,
            "newUsers": 450,
            "activeUsers": 890,
            "retainedUsers": 670
        },
        "loginMetrics": {
            "totalLogins": 5680,
            "uniqueLogins": 1150,
            "avgLoginsPerUser": 4.9
        },
        "gameplayMetrics": {
            "totalGameplays": 12340,
            "avgGameplaysPerUser": 9.9,
            "avgSessionTime": 180
        },
        "dailyStats": [
            {
                "date": "2023-10-01",
                "newUsers": 12,
                "activeUsers": 85,
                "logins": 156,
                "gameplays": 342
            }
        ]
    }
}
```

---

## 3. 应用状态说明

### 3.1 状态类型
- **active**: 正常运行
  - 用户可正常访问
  - 所有功能可用

- **disabled**: 已禁用
  - 用户无法登录
  - API调用被拒绝

- **maintenance**: 维护中
  - 显示维护页面
  - 管理员可正常访问

### 3.2 状态变更规则
- 新创建应用默认为 active
- 只有管理员可以变更状态
- 删除应用前必须先禁用

---

## 4. 应用类型说明

### 4.1 游戏类型 (game)
- 支持排行榜功能
- 游戏数据存储
- 关卡配置管理
- 道具系统

### 4.2 小程序类型 (miniprogram)
- 用户数据管理
- 基础统计功能
- 配置管理
- 邮件通知

---

## 5. API密钥说明

### 5.1 密钥类型
- **apiKey**: 应用公钥，用于标识应用
- **secretKey**: 应用私钥，用于签名验证

### 5.2 密钥管理
- 创建应用时自动生成
- 私钥只在创建时返回一次
- 支持重新生成密钥对
- 密钥变更后需要更新客户端

---

## 6. 数据存储规则

### 6.1 用户数据
- 每个应用独立的用户表：`user_{appId}`
- 支持自定义用户数据结构
- 自动统计用户数量

### 6.2 配置数据
- 应用级配置存储
- 支持热更新
- 配置版本控制

### 6.3 统计数据
- 实时统计计算
- 每日数据汇总
- 历史数据保留90天

---

## 7. 业务规则

### 7.1 应用规则
- 应用ID必须唯一，3-20个字符
- 应用名称长度限制50个字符
- 删除应用会清除所有相关数据
- 应用类型创建后不可修改

### 7.2 权限规则
- 超级管理员可以管理所有应用
- 管理员可以创建和管理应用
- 运营人员只能查看应用信息
- 查看者只有只读权限

---

## 8. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 参数错误/无效应用类型 |
| 4002 | 应用ID已存在 |
| 4003 | 权限不足/状态不允许操作 |
| 4004 | 应用不存在 |
| 5001 | 服务器内部错误 |
