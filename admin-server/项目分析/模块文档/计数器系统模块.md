# 计数器系统模块

## 1. 模块概述

计数器系统模块负责管理游戏中的各种计数器和统计数据，支持全局计数器、用户计数器和应用计数器等多种类型。

### 1.1 主要功能
- 计数器增减操作
- 计数器重置功能
- 计数器查询统计
- 定时重置任务
- 计数器监控告警

### 1.2 涉及云函数
- `getCounter` - 获取计数器值
- `increaseCounter` - 增加计数器
- `decreaseCounter` - 减少计数器
- `resetCounter` - 重置计数器
- `getCounterStats` - 获取计数器统计

---

## 2. 接口详情

### 2.1 获取计数器值

#### getCounter
**功能**: 获取计数器当前值  
**权限**: 根据计数器类型确定权限要求

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| counterType | string | 是 | 计数器类型 |
| counterId | string | 是 | 计数器ID |
| playerId | string | 否 | 玩家ID（用户计数器必填） |

**计数器类型**:
- global: 全局计数器
- app: 应用级计数器
- user: 用户级计数器
- daily: 日计数器
- weekly: 周计数器

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "counterId": "daily_login",
        "counterType": "daily",
        "counterName": "每日登录计数",
        "currentValue": 1250,
        "maxValue": null,
        "resetPeriod": "daily",
        "lastResetTime": "2023-10-01T00:00:00.000Z",
        "nextResetTime": "2023-10-02T00:00:00.000Z",
        "updateTime": "2023-10-01T10:30:00.000Z",
        "metadata": {
            "description": "统计每日登录用户数量",
            "unit": "人次"
        }
    }
}
```

---

### 2.2 增加计数器

#### increaseCounter
**功能**: 增加计数器值  
**权限**: 根据计数器类型确定权限要求

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| counterType | string | 是 | 计数器类型 |
| counterId | string | 是 | 计数器ID |
| playerId | string | 否 | 玩家ID（用户计数器必填） |
| increment | number | 否 | 增加值（默认：1） |
| metadata | object | 否 | 附加数据 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "增加成功",
    "timestamp": 1603991234567,
    "data": {
        "counterId": "daily_login",
        "oldValue": 1250,
        "newValue": 1251,
        "increment": 1,
        "updateTime": "2023-10-01T10:30:00.000Z",
        "hitThreshold": false,
        "thresholds": [
            {
                "value": 1000,
                "triggered": true,
                "triggerTime": "2023-10-01T08:15:00.000Z"
            }
        ]
    }
}
```

---

### 2.3 减少计数器

#### decreaseCounter
**功能**: 减少计数器值  
**权限**: 根据计数器类型确定权限要求

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| counterType | string | 是 | 计数器类型 |
| counterId | string | 是 | 计数器ID |
| playerId | string | 否 | 玩家ID（用户计数器必填） |
| decrement | number | 否 | 减少值（默认：1） |
| allowNegative | boolean | 否 | 是否允许负值（默认：false） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "减少成功",
    "timestamp": 1603991234567,
    "data": {
        "counterId": "energy_points",
        "oldValue": 5,
        "newValue": 4,
        "decrement": 1,
        "updateTime": "2023-10-01T10:30:00.000Z",
        "reachedMinimum": false
    }
}
```

---

### 2.4 重置计数器

#### resetCounter
**功能**: 重置计数器值  
**权限**: 需要 counter_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| counterType | string | 是 | 计数器类型 |
| counterId | string | 是 | 计数器ID |
| playerId | string | 否 | 玩家ID（用户计数器必填） |
| resetValue | number | 否 | 重置后的值（默认：0） |
| reason | string | 是 | 重置原因 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "重置成功",
    "timestamp": 1603991234567,
    "data": {
        "counterId": "daily_login",
        "oldValue": 1251,
        "newValue": 0,
        "resetTime": "2023-10-01T10:30:00.000Z",
        "reason": "日周期重置",
        "operatorId": "admin_123"
    }
}
```

---

### 2.5 获取计数器统计

#### getCounterStats
**功能**: 获取计数器统计信息  
**权限**: 需要 data_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| counterType | string | 否 | 计数器类型筛选 |
| startDate | string | 否 | 开始日期 |
| endDate | string | 否 | 结束日期 |
| groupBy | string | 否 | 分组维度（hour/day/week） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "summary": {
            "totalCounters": 25,
            "activeCounters": 20,
            "totalOperations": 15680,
            "avgValue": 245.6
        },
        "counterList": [
            {
                "counterId": "daily_login",
                "counterName": "每日登录",
                "currentValue": 1251,
                "peakValue": 1890,
                "operationCount": 1251,
                "lastUpdateTime": "2023-10-01T10:30:00.000Z"
            }
        ],
        "timeSeries": [
            {
                "time": "2023-10-01T10:00:00.000Z",
                "value": 1200,
                "operations": 156
            }
        ],
        "topCounters": [
            {
                "counterId": "daily_login",
                "value": 1251,
                "ranking": 1
            }
        ]
    }
}
```

---

## 3. 计数器类型说明

### 3.1 全局计数器 (global)
- 全服总在线人数
- 全服总注册用户数
- 全服总游戏局数
- 系统运行时长

**特点**:
- 所有应用共享
- 需要高权限操作
- 用于系统级统计

### 3.2 应用计数器 (app)
- 应用日活跃用户
- 应用总收入
- 应用游戏总局数
- 应用错误次数

**特点**:
- 按应用隔离
- 应用管理员可操作
- 用于应用级统计

### 3.3 用户计数器 (user)
- 用户游戏局数
- 用户登录天数
- 用户消费金额
- 用户在线时长

**特点**:
- 每个用户独立
- 用户可查看自己的
- 用于个人数据统计

### 3.4 周期计数器
- **日计数器 (daily)**: 每日0点重置
- **周计数器 (weekly)**: 每周一0点重置
- **月计数器 (monthly)**: 每月1号0点重置

---

## 4. 重置机制

### 4.1 自动重置
- 定时任务触发
- 按配置的重置周期执行
- 保留历史数据快照
- 重置操作日志记录

### 4.2 手动重置
- 管理员手动触发
- 需要填写重置原因
- 支持批量重置
- 重置前数据备份

### 4.3 重置策略
- **值重置**: 重置为指定值（通常为0）
- **保持重置**: 保持当前值不变
- **相对重置**: 按比例或差值重置

---

## 5. 阈值监控

### 5.1 阈值配置
- 设置监控阈值
- 多级阈值支持
- 达到阈值触发告警
- 自动执行响应动作

### 5.2 告警机制
- 邮件通知
- 短信提醒
- 系统内消息
- Webhook回调

### 5.3 响应动作
- 发送奖励邮件
- 触发活动事件
- 调用自定义接口
- 记录特殊日志

---

## 6. 性能优化

### 6.1 缓存策略
- 热点计数器缓存
- 批量更新优化
- 延迟写入机制
- 缓存失效处理

### 6.2 数据分片
- 按时间分片存储
- 按用户ID分片
- 按应用ID分片
- 历史数据归档

### 6.3 并发控制
- 乐观锁机制
- 原子操作保证
- 分布式锁支持
- 冲突重试机制

---

## 7. 数据存储说明

计数器系统模块的数据存储设计详见 `项目分析/数据库设计.md` 文档，主要涉及以下数据表：

- **counters**: 计数器主表
- **counter_history**: 计数器历史记录表
- **counter_config**: 计数器配置表
- **counter_operations**: 计数器操作日志表

这些表的详细结构、索引设计和关系说明请参考数据库设计文档。

---

## 8. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 参数错误/计数器ID无效 |
| 4003 | 权限不足 |
| 4004 | 计数器不存在 |
| 4005 | 计数器值超出限制/不允许负值 |
| 5001 | 服务器内部错误 |
