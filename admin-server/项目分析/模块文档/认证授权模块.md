# 认证授权模块

## 1. 模块概述

认证授权模块是系统的安全核心，负责管理员身份验证、权限控制、会话管理等功能。

### 1.1 主要功能
- 用户身份认证
- Token生成与验证
- 权限控制
- 会话管理
- 操作日志记录

### 1.2 涉及云函数
- `adminLogin` - 管理员登录
- `checkToken` - Token验证
- `logout` - 退出登录
- `refreshToken` - 刷新Token

---

## 2. 接口详情

### 2.1 管理员登录

#### adminLogin
**功能**: 管理员登录验证  
**权限**: 无需权限验证

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |
| rememberMe | boolean | 否 | 记住我（默认：false） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "登录成功",
    "timestamp": 1603991234567,
    "data": {
        "token": "abc123def456ghi789",
        "tokenExpire": "2023-11-01T10:00:00.000Z",
        "adminInfo": {
            "id": "admin_id_123456",
            "username": "admin",
            "nickname": "系统管理员",
            "role": "super_admin",
            "roleName": "超级管理员",
            "permissions": ["admin_manage", "role_manage", "app_manage"],
            "email": "admin@example.com",
            "phone": "13800138000",
            "lastLoginTime": "2023-09-30T15:30:00.000Z",
            "createTime": "2023-09-01T10:00:00.000Z"
        }
    }
}
```

**错误码**:
- 4001: 用户名或密码错误
- 4003: 账户被锁定
- 5001: 服务器内部错误

---

### 2.2 Token验证

#### checkToken
**功能**: 验证Token有效性  
**权限**: 需要有效Token

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| token | string | 是 | 访问令牌 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "Token有效",
    "timestamp": 1603991234567,
    "data": {
        "valid": true,
        "adminInfo": {
            "id": "admin_id_123456",
            "username": "admin",
            "nickname": "系统管理员",
            "role": "super_admin",
            "permissions": ["admin_manage", "role_manage", "app_manage"]
        },
        "tokenExpire": "2023-11-01T10:00:00.000Z"
    }
}
```

**错误码**:
- 4002: Token无效或已过期
- 4004: 账户不存在或被禁用

---

### 2.3 退出登录

#### logout
**功能**: 用户退出登录  
**权限**: 需要有效Token

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| token | string | 是 | 访问令牌 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "退出成功",
    "timestamp": 1603991234567,
    "data": {
        "logoutTime": "2023-10-01T10:00:00.000Z"
    }
}
```

---

### 2.4 刷新Token

#### refreshToken
**功能**: 刷新访问令牌  
**权限**: 需要有效Token

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| token | string | 是 | 当前令牌 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "刷新成功",
    "timestamp": 1603991234567,
    "data": {
        "newToken": "xyz789abc123def456",
        "tokenExpire": "2023-11-08T10:00:00.000Z",
        "oldTokenExpire": "2023-11-01T10:00:00.000Z"
    }
}
```

---

## 3. 权限系统说明

### 3.1 角色定义
- **super_admin**: 超级管理员 - 拥有所有权限
- **admin**: 管理员 - 应用管理、用户管理权限
- **operator**: 运营人员 - 用户管理、数据查看权限
- **viewer**: 查看者 - 只读权限

### 3.2 权限列表
- `admin_manage`: 管理员管理
- `role_manage`: 角色管理
- `app_manage`: 应用管理
- `user_manage`: 用户管理
- `config_manage`: 配置管理
- `data_view`: 数据查看
- `mail_send`: 邮件发送

### 3.3 权限验证流程
1. 请求携带Token
2. 验证Token有效性
3. 获取用户角色和权限
4. 检查接口所需权限
5. 通过/拒绝访问

---

## 4. Token机制

### 4.1 Token生成规则
- 使用JWT标准
- 包含用户ID、角色、权限信息
- 使用HMAC-SHA256签名
- 默认有效期7天，记住我30天

### 4.2 Token安全特性
- 防重放攻击
- 自动过期机制
- 签名验证
- 黑名单机制（退出登录后失效）

---

## 5. 会话管理

### 5.1 登录限制
- 同一账户最多同时3个活跃会话
- 新登录会踢掉最早的会话
- 支持查看活跃会话列表

### 5.2 安全策略
- 登录失败5次锁定账户30分钟
- 异地登录邮件通知
- 长时间未活动自动退出

---

## 6. 操作日志

### 6.1 日志记录范围
- 所有管理员登录/退出
- 权限相关操作
- 重要数据修改
- 系统配置变更

### 6.2 日志内容
- 操作时间
- 操作者信息
- 操作类型
- 操作对象
- 操作结果
- IP地址和设备信息

---

## 7. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 用户名或密码错误 |
| 4002 | Token无效或已过期 |
| 4003 | 权限不足 |
| 4004 | 账户不存在或被禁用 |
| 4005 | 登录失败次数过多，账户被锁定 |
| 5001 | 服务器内部错误 |