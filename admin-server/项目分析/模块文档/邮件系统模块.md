# 邮件系统模块

## 1. 模块概述

邮件系统模块负责游戏内邮件的发送、接收和管理功能，支持系统邮件、个人邮件和群发邮件等多种邮件类型。

### 1.1 主要功能
- 邮件发送和接收
- 邮件分类管理
- 附件道具发放
- 邮件模板管理
- 群发邮件功能

### 1.2 涉及云函数
- `getMailList` - 获取邮件列表
- `readMail` - 阅读邮件
- `sendMail` - 发送邮件
- `deleteMail` - 删除邮件
- `claimAttachment` - 领取附件
- `sendBatchMail` - 批量发送邮件

---

## 2. 接口详情

### 2.1 获取邮件列表

#### getMailList
**功能**: 获取用户邮件列表  
**权限**: 需要用户登录Token

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| token | string | 是 | 用户Token |
| mailType | string | 否 | 邮件类型筛选 |
| status | string | 否 | 状态筛选（all/unread/read） |
| page | number | 否 | 页码（默认：1） |
| pageSize | number | 否 | 每页数量（默认：20） |

**邮件类型**:
- system: 系统邮件
- personal: 个人邮件
- activity: 活动邮件
- reward: 奖励邮件

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "mails": [
            {
                "mailId": "mail_123456",
                "mailType": "system",
                "title": "每日签到奖励",
                "content": "恭喜您获得今日签到奖励！",
                "senderId": "system",
                "senderName": "系统",
                "receiverId": "player_001",
                "attachments": [
                    {
                        "itemId": "coin",
                        "itemName": "金币",
                        "quantity": 100,
                        "claimed": false
                    }
                ],
                "status": "unread",
                "priority": "normal",
                "sendTime": "2023-10-01T10:00:00.000Z",
                "expireTime": "2023-10-08T10:00:00.000Z",
                "readTime": null,
                "claimTime": null
            }
        ],
        "pagination": {
            "page": 1,
            "pageSize": 20,
            "total": 156,
            "totalPages": 8
        },
        "summary": {
            "unreadCount": 12,
            "unclaimedCount": 5
        }
    }
}
```

---

### 2.2 阅读邮件

#### readMail
**功能**: 阅读邮件详情  
**权限**: 需要用户登录Token

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| token | string | 是 | 用户Token |
| mailId | string | 是 | 邮件ID |

**输出结果**:
```json
{
    "code": 0,
    "msg": "读取成功",
    "timestamp": 1603991234567,
    "data": {
        "mailId": "mail_123456",
        "mailType": "system",
        "title": "每日签到奖励",
        "content": "恭喜您获得今日签到奖励！详细内容包括...",
        "senderId": "system",
        "senderName": "系统",
        "receiverId": "player_001",
        "attachments": [
            {
                "attachmentId": "att_001",
                "itemId": "coin",
                "itemName": "金币",
                "quantity": 100,
                "claimed": false
            }
        ],
        "status": "read",
        "priority": "normal",
        "sendTime": "2023-10-01T10:00:00.000Z",
        "readTime": "2023-10-01T10:30:00.000Z",
        "expireTime": "2023-10-08T10:00:00.000Z"
    }
}
```

---

### 2.3 发送邮件

#### sendMail
**功能**: 发送邮件（管理员功能）  
**权限**: 需要 mail_send 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| receiverType | string | 是 | 接收者类型（single/all/condition） |
| receiverIds | array | 否 | 接收者ID列表（single类型必填） |
| receiverCondition | object | 否 | 接收条件（condition类型必填） |
| mailType | string | 是 | 邮件类型 |
| title | string | 是 | 邮件标题 |
| content | string | 是 | 邮件内容 |
| attachments | array | 否 | 附件列表 |
| priority | string | 否 | 优先级（normal/high/urgent） |
| expireDays | number | 否 | 过期天数（默认：7） |

**接收条件示例**:
```json
{
    "level": {"min": 10, "max": 50},
    "registerTime": {"after": "2023-09-01"},
    "lastLoginTime": {"before": "2023-09-20"}
}
```

**输出结果**:
```json
{
    "code": 0,
    "msg": "发送成功",
    "timestamp": 1603991234567,
    "data": {
        "mailId": "mail_123456",
        "receiverType": "condition",
        "targetCount": 1250,
        "sentCount": 1245,
        "failedCount": 5,
        "sendTime": "2023-10-01T10:00:00.000Z",
        "taskId": "task_789",
        "status": "completed"
    }
}
```

---

### 2.4 删除邮件

#### deleteMail
**功能**: 删除邮件  
**权限**: 需要用户登录Token

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| token | string | 是 | 用户Token |
| mailIds | array | 是 | 邮件ID列表 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "删除成功",
    "timestamp": 1603991234567,
    "data": {
        "deletedCount": 3,
        "failedCount": 0,
        "deletedMails": [
            {
                "mailId": "mail_123456",
                "title": "每日签到奖励",
                "deleteTime": "2023-10-01T10:00:00.000Z"
            }
        ]
    }
}
```

---

### 2.5 领取附件

#### claimAttachment
**功能**: 领取邮件附件  
**权限**: 需要用户登录Token

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| token | string | 是 | 用户Token |
| mailId | string | 是 | 邮件ID |
| attachmentIds | array | 否 | 附件ID列表（空则领取全部） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "领取成功",
    "timestamp": 1603991234567,
    "data": {
        "mailId": "mail_123456",
        "claimedAttachments": [
            {
                "attachmentId": "att_001",
                "itemId": "coin",
                "itemName": "金币",
                "quantity": 100,
                "claimTime": "2023-10-01T10:00:00.000Z"
            }
        ],
        "addedItems": {
            "coin": 100,
            "exp": 50
        },
        "allClaimed": true
    }
}
```

---

### 2.6 批量发送邮件

#### sendBatchMail
**功能**: 批量发送邮件（系统定时任务）  
**权限**: 需要 mail_batch_send 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| templateId | string | 是 | 邮件模板ID |
| receiverType | string | 是 | 接收者类型 |
| receiverCondition | object | 否 | 接收条件 |
| variables | object | 否 | 模板变量 |
| scheduleTime | string | 否 | 定时发送时间 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "任务创建成功",
    "timestamp": 1603991234567,
    "data": {
        "taskId": "batch_123456",
        "templateId": "template_001",
        "estimatedCount": 5000,
        "scheduleTime": "2023-10-01T20:00:00.000Z",
        "status": "scheduled",
        "createTime": "2023-10-01T10:00:00.000Z"
    }
}
```

---

## 3. 邮件类型说明

### 3.1 系统邮件 (system)
- 系统公告
- 维护通知
- 版本更新说明
- 重要活动通知

### 3.2 个人邮件 (personal)
- 玩家间私信
- 客服回复
- 个性化推荐
- 生日祝福

### 3.3 活动邮件 (activity)
- 活动开始通知
- 活动奖励发放
- 限时任务提醒
- 节日祝福

### 3.4 奖励邮件 (reward)
- 每日签到奖励
- 成就完成奖励
- 补偿奖励
- 排行榜奖励

---

## 4. 邮件模板管理

### 4.1 模板功能
- 预设邮件格式
- 动态内容变量
- 多语言支持
- 样式自定义

### 4.2 模板变量
- `{playerName}`: 玩家昵称
- `{level}`: 玩家等级
- `{date}`: 当前日期
- `{serverName}`: 服务器名称

### 4.3 使用场景
- 批量邮件发送
- 定时邮件任务
- 自动化奖励发放
- 统一邮件格式

---

## 5. 附件管理

### 5.1 附件类型
- 游戏道具
- 虚拟货币
- 经验值
- 特殊物品

### 5.2 附件发放
- 自动发放到背包
- 需要手动领取
- 批量领取功能
- 过期自动清理

### 5.3 领取限制
- 背包容量检查
- 道具上限验证
- 等级权限限制
- 时间窗口控制

---

## 6. 数据存储说明

邮件系统模块的数据存储设计详见 `项目分析/数据库设计.md` 文档，主要涉及以下数据表：

- **mail_messages**: 邮件主表
- **mail_attachments**: 邮件附件表
- **mail_templates**: 邮件模板表
- **mail_send_tasks**: 批量发送任务表

这些表的详细结构、索引设计和关系说明请参考数据库设计文档。

---

## 7. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 参数错误/邮件格式无效 |
| 4003 | Token无效/权限不足 |
| 4004 | 邮件不存在/模板不存在 |
| 4005 | 邮件已过期/附件已领取 |
| 5001 | 服务器内部错误 |
