# 排行榜系统模块

## 1. 模块概述

排行榜系统模块负责游戏中各种排行榜的管理，包括分数排行、等级排行、周期性排行榜等功能。

### 1.1 主要功能
- 多类型排行榜管理
- 实时排行榜更新
- 周期性排行榜重置
- 排行榜数据查询
- 排行榜奖励管理

### 1.2 涉及云函数
- `getLeaderboardData` - 获取排行榜数据
- `updateLeaderboard` - 更新排行榜数据
- `createLeaderboard` - 创建排行榜
- `resetLeaderboard` - 重置排行榜
- `getPlayerRank` - 获取玩家排名
- `getLeaderboardRewards` - 获取排行榜奖励

---

## 2. 接口详情

### 2.1 获取排行榜数据

#### getLeaderboardData
**功能**: 获取排行榜数据  
**权限**: 无需权限（游戏客户端调用）

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| leaderboardType | string | 是 | 排行榜类型 |
| period | string | 否 | 周期（daily/weekly/monthly/all，默认：all） |
| limit | number | 否 | 返回数量（默认：50，最大100） |
| playerId | string | 否 | 玩家ID（获取周围排名时需要） |
| offset | number | 否 | 偏移量（分页用） |

**排行榜类型**:
- score: 分数排行榜
- level: 等级排行榜
- time: 时间排行榜（速通）
- custom: 自定义排行榜

**输出结果**:
```json
{
    "code": 0,
    "msg": "success",
    "timestamp": 1603991234567,
    "data": {
        "leaderboardType": "score",
        "period": "weekly",
        "periodStartTime": "2023-09-25T00:00:00.000Z",
        "periodEndTime": "2023-10-01T23:59:59.000Z",
        "totalPlayers": 1250,
        "lastUpdateTime": "2023-10-01T10:00:00.000Z",
        "rankings": [
            {
                "rank": 1,
                "playerId": "600001",
                "nickname": "玩家001",
                "avatar": "https://example.com/avatar/001.jpg",
                "score": 125600,
                "level": 25,
                "updateTime": "2023-10-01T09:30:00.000Z"
            },
            {
                "rank": 2,
                "playerId": "600002",
                "nickname": "玩家002",
                "avatar": "https://example.com/avatar/002.jpg",
                "score": 118900,
                "level": 23,
                "updateTime": "2023-10-01T08:45:00.000Z"
            }
        ],
        "playerRank": {
            "rank": 15,
            "score": 85600,
            "level": 18,
            "percentile": 88.5
        }
    }
}
```

---

### 2.2 更新排行榜数据

#### updateLeaderboard
**功能**: 更新玩家排行榜数据  
**权限**: 需要有效token（游戏客户端调用）

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| playerId | string | 是 | 玩家ID |
| leaderboardType | string | 是 | 排行榜类型 |
| score | number | 是 | 分数/数值 |
| metadata | object | 否 | 附加数据 |

**metadata对象示例**:
```json
{
    "level": 18,
    "gameTime": 180,
    "moves": 45,
    "difficulty": "hard"
}
```

**输出结果**:
```json
{
    "code": 0,
    "msg": "更新成功",
    "timestamp": 1603991234567,
    "data": {
        "playerId": "600001",
        "leaderboardType": "score",
        "newScore": 95600,
        "oldScore": 85600,
        "newRank": 12,
        "oldRank": 15,
        "isNewRecord": true,
        "rankChange": 3,
        "updateTime": "2023-10-01T10:00:00.000Z"
    }
}
```

**错误码**:
- 4001: 参数错误或无效排行榜类型
- 4003: Token无效或玩家不存在
- 4004: 排行榜不存在
- 5001: 服务器内部错误

---

### 2.3 创建排行榜

#### createLeaderboard
**功能**: 创建新的排行榜  
**权限**: 需要 config_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| leaderboardType | string | 是 | 排行榜类型标识 |
| name | string | 是 | 排行榜名称 |
| description | string | 否 | 排行榜描述 |
| sortOrder | string | 否 | 排序方式（desc/asc，默认：desc） |
| resetPeriod | string | 否 | 重置周期（never/daily/weekly/monthly） |
| maxEntries | number | 否 | 最大条目数（默认：1000） |
| enabled | boolean | 否 | 是否启用（默认：true） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "创建成功",
    "timestamp": 1603991234567,
    "data": {
        "leaderboardId": "lb_score_weekly_001",
        "leaderboardType": "score_weekly",
        "name": "周分数排行榜",
        "sortOrder": "desc",
        "resetPeriod": "weekly",
        "maxEntries": 1000,
        "enabled": true,
        "createTime": "2023-10-01T10:00:00.000Z"
    }
}
```

---

### 2.4 重置排行榜

#### resetLeaderboard
**功能**: 手动重置排行榜数据  
**权限**: 需要 config_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| leaderboardType | string | 是 | 排行榜类型 |
| archiveOldData | boolean | 否 | 是否归档旧数据（默认：true） |
| reason | string | 否 | 重置原因 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "重置成功",
    "timestamp": 1603991234567,
    "data": {
        "leaderboardType": "score_weekly",
        "resetTime": "2023-10-01T10:00:00.000Z",
        "archivedEntries": 1250,
        "operatorId": "admin_123",
        "reason": "新赛季开始",
        "newPeriodId": "period_2023_w40"
    }
}
```

---

### 2.5 获取玩家排名

#### getPlayerRank
**功能**: 获取指定玩家的排名信息  
**权限**: 无需权限（游戏客户端调用）

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| playerId | string | 是 | 玩家ID |
| leaderboardType | string | 是 | 排行榜类型 |
| period | string | 否 | 周期（默认：当前周期） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "playerId": "600001",
        "leaderboardType": "score",
        "period": "weekly",
        "rank": 15,
        "score": 85600,
        "totalPlayers": 1250,
        "percentile": 88.5,
        "rankHistory": [
            {
                "date": "2023-10-01",
                "rank": 15,
                "score": 85600
            },
            {
                "date": "2023-09-30",
                "rank": 18,
                "score": 82300
            }
        ],
        "aroundRankings": [
            {
                "rank": 13,
                "playerId": "600013",
                "nickname": "玩家013",
                "score": 87200
            },
            {
                "rank": 14,
                "playerId": "600014",
                "nickname": "玩家014",
                "score": 86400
            },
            {
                "rank": 15,
                "playerId": "600001",
                "nickname": "玩家001",
                "score": 85600,
                "isCurrentPlayer": true
            },
            {
                "rank": 16,
                "playerId": "600016",
                "nickname": "玩家016",
                "score": 84900
            }
        ]
    }
}
```

---

### 2.6 获取排行榜奖励

#### getLeaderboardRewards
**功能**: 获取排行榜奖励配置和发放状态  
**权限**: 需要 config_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| leaderboardType | string | 是 | 排行榜类型 |
| period | string | 否 | 周期标识 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "leaderboardType": "score_weekly",
        "period": "2023_w39",
        "rewardStatus": "distributed",
        "distributionTime": "2023-10-02T00:00:00.000Z",
        "rewardRules": [
            {
                "rankRange": "1-1",
                "rankName": "冠军",
                "rewards": {
                    "coins": 10000,
                    "gems": 100,
                    "items": [
                        {
                            "itemId": "golden_trophy",
                            "count": 1
                        }
                    ]
                }
            },
            {
                "rankRange": "2-3",
                "rankName": "亚军季军",
                "rewards": {
                    "coins": 5000,
                    "gems": 50,
                    "items": [
                        {
                            "itemId": "silver_trophy",
                            "count": 1
                        }
                    ]
                }
            },
            {
                "rankRange": "4-10",
                "rankName": "前十名",
                "rewards": {
                    "coins": 2000,
                    "gems": 20
                }
            }
        ],
        "winners": [
            {
                "rank": 1,
                "playerId": "600001",
                "nickname": "玩家001",
                "score": 125600,
                "rewardsSent": true,
                "sentTime": "2023-10-02T00:00:00.000Z"
            }
        ]
    }
}
```

---

## 3. 排行榜类型说明

### 3.1 基础排行榜
- **score**: 分数排行榜（最常用）
- **level**: 等级排行榜
- **time**: 时间排行榜（速通类游戏）
- **custom**: 自定义数值排行榜

### 3.2 周期性排行榜
- **daily**: 每日排行榜（每天0点重置）
- **weekly**: 每周排行榜（每周一0点重置）
- **monthly**: 每月排行榜（每月1日0点重置）
- **season**: 赛季排行榜（手动重置）

### 3.3 特殊排行榜
- **friends**: 好友排行榜
- **guild**: 公会/团队排行榜
- **regional**: 地区排行榜

---

## 4. 排行榜数据结构

### 4.1 排行榜配置
```json
{
    "leaderboardId": "lb_score_weekly_001",
    "appId": "game001",
    "leaderboardType": "score_weekly",
    "name": "周分数排行榜",
    "description": "每周分数竞赛",
    "sortOrder": "desc",
    "resetPeriod": "weekly",
    "maxEntries": 1000,
    "enabled": true,
    "createTime": "2023-10-01T10:00:00.000Z"
}
```

### 4.2 排行榜条目
```json
{
    "playerId": "600001",
    "leaderboardType": "score_weekly",
    "period": "2023_w39",
    "score": 125600,
    "rank": 1,
    "metadata": {
        "level": 25,
        "gameTime": 180,
        "difficulty": "hard"
    },
    "updateTime": "2023-10-01T09:30:00.000Z"
}
```

---

## 5. 排行榜更新规则

### 5.1 分数更新规则
- **替换模式**: 新分数直接替换旧分数
- **累加模式**: 新分数累加到旧分数
- **最佳模式**: 只保留最高分数（默认）

### 5.2 排名计算规则
- 相同分数按时间先后排序
- 支持分页查询大排行榜
- 实时更新排名变化
- 缓存热门排行榜数据

### 5.3 数据归档规则
- 周期结束后自动归档数据
- 归档数据保留90天
- 支持历史排行榜查询
- 奖励发放基于归档数据

---

## 6. 奖励系统

### 6.1 奖励配置
- 支持多种奖励类型（金币、道具、称号）
- 按排名区间配置不同奖励
- 支持特殊节日奖励加成
- 奖励发放状态跟踪

### 6.2 发放规则
- 周期结束后自动发放
- 支持手动触发发放
- 发放失败自动重试
- 发放记录审计日志

---

## 7. 性能优化

### 7.1 数据库优化
- 分表存储不同周期数据
- 排行榜字段建立复合索引
- 定期清理过期数据
- 热点数据预加载

### 7.2 缓存策略
- 前50名实时缓存
- 玩家排名信息缓存
- 排行榜配置缓存
- 分布式缓存更新

---

## 8. 监控与统计

### 8.1 关键指标
- 排行榜参与率
- 分数分布情况
- 更新频率统计
- 查询性能监控

### 8.2 异常检测
- 异常高分检测
- 刷分行为识别
- 排行榜更新异常
- 奖励发放异常

---

## 9. 数据存储说明

排行榜系统模块的数据存储设计详见 `项目分析/数据库设计.md` 文档，主要涉及以下数据表：

- **leaderboard_config**: 排行榜配置表
- **leaderboard_score**: 排行榜分数记录表  
- **leaderboard_periods**: 排行榜周期管理表
- **leaderboard_rewards**: 排行榜奖励发放记录表

这些表的详细结构、索引设计和关系说明请参考数据库设计文档。

---

## 10. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 参数错误/无效排行榜类型 |
| 4003 | Token无效/权限不足 |
| 4004 | 排行榜不存在/玩家不存在 |
| 4005 | 排行榜已禁用/周期已结束 |
| 5001 | 服务器内部错误 |
