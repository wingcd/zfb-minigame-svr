# 用户管理模块

## 1. 模块概述

用户管理模块负责游戏玩家的数据管理、状态控制、行为分析等功能，是游戏运营的核心模块。

### 1.1 主要功能
- 用户数据查询与管理
- 用户状态控制（封禁/解禁）
- 用户行为分析
- 批量用户操作

### 1.2 涉及云函数
- `getUserList` - 获取用户列表
- `getUserInfo` - 获取用户详情
- `updateUserData` - 更新用户数据
- `banUser` - 封禁用户
- `unbanUser` - 解封用户
- `deleteUser` - 删除用户数据

---

## 2. 接口详情

### 2.1 获取用户列表

#### getUserList
**功能**: 获取应用用户列表  
**权限**: 需要 user_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| page | number | 否 | 页码（默认：1） |
| limit | number | 否 | 每页数量（默认：20，最大100） |
| status | string | 否 | 状态筛选（all/active/banned） |
| keyword | string | 否 | 关键词搜索（玩家ID/昵称） |
| registerStartDate | string | 否 | 注册开始日期（YYYY-MM-DD） |
| registerEndDate | string | 否 | 注册结束日期（YYYY-MM-DD） |
| sortBy | string | 否 | 排序字段（registerTime/lastLoginTime/loginCount） |
| sortOrder | string | 否 | 排序方向（asc/desc，默认：desc） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "list": [
            {
                "playerId": "600001",
                "openId": "ox1234567890abcdef",
                "nickname": "玩家001",
                "avatar": "https://example.com/avatar/001.jpg",
                "level": 15,
                "experience": 2850,
                "coins": 12500,
                "banned": false,
                "banReason": null,
                "banExpire": null,
                "loginCount": 45,
                "lastLoginTime": "2023-10-01T08:30:00.000Z",
                "lastLoginIp": "192.168.1.100",
                "registerTime": "2023-09-15T10:00:00.000Z",
                "totalGameTime": 18650
            }
        ],
        "total": 1250,
        "page": 1,
        "limit": 20,
        "totalPages": 63,
        "summary": {
            "totalUsers": 1250,
            "activeUsers": 890,
            "bannedUsers": 12,
            "newUsersToday": 8
        }
    }
}
```

---

### 2.2 获取用户详情

#### getUserInfo
**功能**: 获取用户详细信息  
**权限**: 需要 user_view 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| playerId | string | 是 | 玩家ID |

**输出结果**:
```json
{
    "code": 0,
    "msg": "查询成功",
    "timestamp": 1603991234567,
    "data": {
        "userInfo": {
            "playerId": "600001",
            "openId": "ox1234567890abcdef",
            "nickname": "玩家001",
            "avatar": "https://example.com/avatar/001.jpg",
            "level": 15,
            "experience": 2850,
            "coins": 12500,
            "banned": false,
            "banReason": null,
            "banExpire": null,
            "registerTime": "2023-09-15T10:00:00.000Z",
            "lastLoginTime": "2023-10-01T08:30:00.000Z",
            "lastLoginIp": "192.168.1.100",
            "loginCount": 45,
            "totalGameTime": 18650,
            "currentLevel": 5,
            "maxLevel": 15,
            "achievements": ["first_login", "level_10", "play_7_days"]
        },
        "gameData": {
            "currentProgress": {
                "stage": 5,
                "score": 15420,
                "lives": 3,
                "power": 100
            },
            "inventory": {
                "coins": 12500,
                "gems": 50,
                "items": [
                    {
                        "itemId": "boost_bomb",
                        "count": 5
                    }
                ]
            },
            "statistics": {
                "gamesPlayed": 128,
                "highestScore": 25600,
                "totalPlayTime": 18650,
                "averagePlayTime": 146
            }
        },
        "loginHistory": [
            {
                "time": "2023-10-01T08:30:00.000Z",
                "ip": "192.168.1.100",
                "device": "iPhone 14",
                "duration": 1850
            }
        ]
    }
}
```

---

### 2.3 更新用户数据

#### updateUserData
**功能**: 更新用户游戏数据  
**权限**: 需要 user_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| playerId | string | 是 | 玩家ID |
| data | object | 是 | 要更新的数据 |
| reason | string | 否 | 操作原因 |

**data对象结构**:
```json
{
    "level": 16,
    "experience": 3000,
    "coins": 15000,
    "gems": 60,
    "items": {
        "boost_bomb": 10,
        "extra_life": 3
    },
    "achievements": ["level_15"]
}
```

**输出结果**:
```json
{
    "code": 0,
    "msg": "更新成功",
    "timestamp": 1603991234567,
    "data": {
        "playerId": "600001",
        "updatedFields": ["level", "experience", "coins"],
        "updateTime": "2023-10-01T10:00:00.000Z",
        "operatorId": "admin_123",
        "reason": "活动奖励补发"
    }
}
```

**错误码**:
- 4001: 参数错误或数据格式无效
- 4003: 权限不足
- 4004: 用户不存在
- 5001: 服务器内部错误

---

### 2.4 封禁用户

#### banUser
**功能**: 封禁用户账户  
**权限**: 需要 user_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| playerId | string | 是 | 玩家ID |
| reason | string | 是 | 封禁原因 |
| duration | number | 否 | 封禁时长（小时，0表示永久） |
| banType | string | 否 | 封禁类型（login/game/chat，默认：login） |

**封禁类型说明**:
- login: 禁止登录
- game: 禁止游戏（可登录但不能玩）
- chat: 禁止聊天（如果有聊天功能）

**输出结果**:
```json
{
    "code": 0,
    "msg": "封禁成功",
    "timestamp": 1603991234567,
    "data": {
        "playerId": "600001",
        "banType": "login",
        "banReason": "使用外挂软件",
        "banStartTime": "2023-10-01T10:00:00.000Z",
        "banExpire": "2023-10-08T10:00:00.000Z",
        "operatorId": "admin_123",
        "isPermanent": false
    }
}
```

**错误码**:
- 4001: 参数错误
- 4003: 权限不足
- 4004: 用户不存在或已被封禁

---

### 2.5 解封用户

#### unbanUser
**功能**: 解除用户封禁  
**权限**: 需要 user_manage 权限

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| playerId | string | 是 | 玩家ID |
| reason | string | 是 | 解封原因 |

**输出结果**:
```json
{
    "code": 0,
    "msg": "解封成功",
    "timestamp": 1603991234567,
    "data": {
        "playerId": "600001",
        "unbanTime": "2023-10-01T10:00:00.000Z",
        "operatorId": "admin_123",
        "reason": "误封，已核实"
    }
}
```

**错误码**:
- 4001: 参数错误
- 4003: 权限不足
- 4004: 用户不存在或未被封禁

---

### 2.6 删除用户数据

#### deleteUser
**功能**: 删除用户数据（GDPR合规）  
**权限**: 需要 user_manage 权限（仅超级管理员）

**输入参数**:
| 参数名 | 类型 | 必选 | 说明 |
| --- | --- | --- | --- |
| appId | string | 是 | 应用ID |
| playerId | string | 是 | 玩家ID |
| reason | string | 是 | 删除原因 |
| confirmDelete | boolean | 是 | 确认删除（必须为true） |

**输出结果**:
```json
{
    "code": 0,
    "msg": "删除成功",
    "timestamp": 1603991234567,
    "data": {
        "deletedUser": {
            "playerId": "600001",
            "registerTime": "2023-09-15T10:00:00.000Z",
            "lastLoginTime": "2023-10-01T08:30:00.000Z"
        },
        "deleteTime": "2023-10-01T10:00:00.000Z",
        "operatorId": "admin_123",
        "reason": "用户申请数据删除",
        "warning": "用户数据已永久删除，包括游戏进度和道具"
    }
}
```

**错误码**:
- 4001: 参数错误或未确认删除
- 4003: 权限不足（仅超级管理员）
- 4004: 用户不存在

---

## 3. 用户状态说明

### 3.1 基础状态
- **active**: 正常状态，可正常游戏
- **banned**: 被封禁，根据封禁类型限制功能
- **deleted**: 已删除，数据不存在

### 3.2 封禁状态详情
- **login**: 无法登录游戏
- **game**: 可登录但无法开始游戏
- **chat**: 无法发送聊天消息（如果有）

### 3.3 状态变更规则
- 新用户默认为 active
- 封禁可设置时长或永久
- 解封立即生效
- 删除不可恢复

---

## 4. 用户数据结构

### 4.1 基础信息
- playerId: 玩家唯一ID
- openId: 微信/平台开放ID
- nickname: 昵称
- avatar: 头像URL
- registerTime: 注册时间

### 4.2 游戏数据
- level: 当前等级
- experience: 经验值
- coins: 金币数量
- gems: 宝石数量
- items: 道具清单
- achievements: 成就列表

### 4.3 统计数据
- loginCount: 登录次数
- totalGameTime: 总游戏时长
- gamesPlayed: 游戏局数
- highestScore: 最高分数

---

## 5. 数据操作规则

### 5.1 查询规则
- 支持多条件组合查询
- 默认按注册时间倒序
- 分页查询避免性能问题
- 敏感信息脱敏显示

### 5.2 修改规则
- 只能修改游戏相关数据
- 不能修改系统生成字段
- 所有修改记录操作日志
- 重要操作需要管理员权限

### 5.3 删除规则
- 仅支持软删除（标记删除）
- 删除前必须确认操作
- 删除操作不可逆
- 保留删除记录用于审计

---

## 6. 安全与隐私

### 6.1 数据脱敏
- 手机号码：138****8000
- 邮箱地址：user***@example.com
- IP地址：192.168.***.***
- 设备信息：仅显示品牌型号

### 6.2 权限控制
- 查看权限：可查看用户基础信息
- 管理权限：可修改用户数据和状态
- 删除权限：仅超级管理员可删除

### 6.3 操作审计
- 所有用户数据修改记录日志
- 封禁/解封操作记录原因
- 删除操作需要额外确认
- 定期审计权限使用情况

---

## 7. 业务规则

### 7.1 封禁规则
- 封禁时长最长不超过365天
- 永久封禁需要特殊权限
- 连续违规用户自动延长封禁
- 解封需要记录详细原因

### 7.2 数据修改规则
- 不能将等级或经验设为负数
- 道具数量不能超过上限
- 金币/宝石修改需要合理范围
- 成就只能增加不能删除

### 7.3 删除规则
- 删除前必须先封禁账户
- 删除申请需要审批流程
- 删除后相关排行榜数据清理
- 保留删除记录30天

---

## 8. 数据存储说明

用户管理模块的数据存储设计详见 `项目分析/数据库设计.md` 文档，主要涉及以下数据表：

- **user_{appId}**: 用户基础信息表（按应用分表）
- **user_ban_logs**: 用户封禁操作日志表
- **user_data_changes**: 用户数据变更日志表

这些表的详细结构、索引设计和关系说明请参考数据库设计文档。

---

## 9. 错误码汇总

| 错误码 | 说明 |
| --- | --- |
| 4001 | 参数错误/数据格式无效 |
| 4003 | 权限不足/状态不允许操作 |
| 4004 | 用户不存在 |
| 4005 | 用户已被封禁/已删除 |
| 5001 | 服务器内部错误 |
