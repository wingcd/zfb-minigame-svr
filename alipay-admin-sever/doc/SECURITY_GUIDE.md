# åç«¯æƒé™æ ¡éªŒå®‰å…¨æŒ‡å—

## ğŸ”’ å®‰å…¨æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†å¤šå±‚æ¬¡çš„æƒé™æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œæ“ä½œè§„èŒƒã€‚å‰ç«¯æƒé™æ§åˆ¶åªæ˜¯ç”¨æˆ·ä½“éªŒå±‚é¢çš„ä¼˜åŒ–ï¼Œ**çœŸæ­£çš„å®‰å…¨ä¿éšœåœ¨åç«¯å®ç°**ã€‚

## ğŸ›¡ï¸ æƒé™ä½“ç³»æ¶æ„

### æƒé™æ ¡éªŒæµç¨‹
```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ æƒé™ä¸­é—´ä»¶ â†’ ä¸šåŠ¡é€»è¾‘ â†’ æ“ä½œæ—¥å¿— â†’ è¿”å›ç»“æœ
```

### å®‰å…¨å±‚çº§
1. **TokenéªŒè¯** - éªŒè¯ç”¨æˆ·èº«ä»½
2. **æƒé™æ£€æŸ¥** - éªŒè¯æ“ä½œæƒé™
3. **è§’è‰²é™åˆ¶** - ç‰¹æ®Šæ“ä½œçš„è§’è‰²è¦æ±‚
4. **æ“ä½œå®¡è®¡** - è®°å½•æ‰€æœ‰æ“ä½œæ—¥å¿—

## ğŸ”‘ æƒé™ç³»ç»Ÿè®¾è®¡

### å†…ç½®è§’è‰²å’Œæƒé™

| è§’è‰² | è§’è‰²ä»£ç  | æƒé™åˆ—è¡¨ | è¯´æ˜ |
|------|----------|----------|------|
| è¶…çº§ç®¡ç†å‘˜ | `super_admin` | æ‰€æœ‰æƒé™ | ç³»ç»Ÿæœ€é«˜æƒé™ï¼Œä¸å—é™åˆ¶ |
| ç®¡ç†å‘˜ | `admin` | `app_manage`, `user_manage`, `leaderboard_manage`, `stats_view` | å¤§éƒ¨åˆ†ç®¡ç†æƒé™ |
| è¿è¥äººå‘˜ | `operator` | `user_manage`, `leaderboard_manage`, `stats_view` | è¿è¥ç›¸å…³æƒé™ |
| æŸ¥çœ‹è€… | `viewer` | `stats_view` | ä»…æŸ¥çœ‹æƒé™ |

### æƒé™å®šä¹‰

| æƒé™ä»£ç  | æƒé™åç§° | è¯´æ˜ |
|----------|----------|------|
| `admin_manage` | ç®¡ç†å‘˜ç®¡ç† | åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ç®¡ç†å‘˜è´¦æˆ· |
| `role_manage` | è§’è‰²ç®¡ç† | åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤è§’è‰²å’Œæƒé™ |
| `app_manage` | åº”ç”¨ç®¡ç† | ç®¡ç†å°æ¸¸æˆåº”ç”¨ |
| `user_manage` | ç”¨æˆ·ç®¡ç† | ç®¡ç†æ¸¸æˆç”¨æˆ· |
| `leaderboard_manage` | æ’è¡Œæ¦œç®¡ç† | ç®¡ç†æ’è¡Œæ¦œé…ç½®å’Œæ•°æ® |
| `stats_view` | ç»Ÿè®¡æŸ¥çœ‹ | æŸ¥çœ‹ç»Ÿè®¡æ•°æ® |
| `system_config` | ç³»ç»Ÿé…ç½® | ç³»ç»Ÿçº§é…ç½®ï¼ˆé¢„ç•™ï¼‰ |

## ğŸ” æ¥å£æƒé™æ˜ å°„

### åº”ç”¨ç®¡ç†æ¥å£
| æ¥å£è·¯å¾„ | æ‰€éœ€æƒé™ | é¢å¤–é™åˆ¶ |
|----------|----------|----------|
| `POST /app/getAllApps` | `app_manage` | - |
| `POST /app/updateApp` | `app_manage` | - |
| `POST /app/deleteApp` | `app_manage` | ä»…è¶…çº§ç®¡ç†å‘˜ |

### ç”¨æˆ·ç®¡ç†æ¥å£
| æ¥å£è·¯å¾„ | æ‰€éœ€æƒé™ | é¢å¤–é™åˆ¶ |
|----------|----------|----------|
| `POST /user/getAllUsers` | `user_manage` | - |
| `POST /user/banUser` | `user_manage` | - |
| `POST /user/unbanUser` | `user_manage` | - |
| `POST /user/deleteUser` | `user_manage` | ç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜ |

### æ’è¡Œæ¦œç®¡ç†æ¥å£
| æ¥å£è·¯å¾„ | æ‰€éœ€æƒé™ | é¢å¤–é™åˆ¶ |
|----------|----------|----------|
| `POST /leaderboard/getAllLeaderboards` | `leaderboard_manage` | - |
| `POST /leaderboard/updateLeaderboard` | `leaderboard_manage` | - |
| `POST /leaderboard/deleteLeaderboard` | `leaderboard_manage` | ç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜ |

### ç®¡ç†å‘˜æ¥å£
| æ¥å£è·¯å¾„ | æ‰€éœ€æƒé™ | é¢å¤–é™åˆ¶ |
|----------|----------|----------|
| `POST /admin/adminLogin` | æ— éœ€æƒé™ | å®‰å…¨å¤„ç† + æ“ä½œæ—¥å¿— |
| `POST /admin/verifyToken` | æ— éœ€æƒé™ | å®‰å…¨å¤„ç† + æ“ä½œæ—¥å¿— |
| `POST /admin/initAdmin` | æ— éœ€æƒé™ | ç³»ç»Ÿåˆå§‹åŒ–ï¼Œç‰¹æ®Šå®‰å…¨æ§åˆ¶ |
| `POST /admin/getAdminList` | `admin_manage` | - |
| `POST /admin/createAdmin` | `admin_manage` | ä¸èƒ½åˆ›å»ºæ¯”è‡ªå·±æƒé™æ›´é«˜çš„ç®¡ç†å‘˜ |
| `POST /admin/updateAdmin` | `admin_manage` | ä¸èƒ½ä¿®æ”¹æ¯”è‡ªå·±æƒé™æ›´é«˜çš„ç®¡ç†å‘˜ |
| `POST /admin/deleteAdmin` | `admin_manage` | ä»…è¶…çº§ç®¡ç†å‘˜ï¼Œä¸èƒ½åˆ é™¤è‡ªå·±å’Œæœ€åä¸€ä¸ªè¶…çº§ç®¡ç†å‘˜ |
| `POST /admin/resetPassword` | `admin_manage` | ä¸èƒ½é‡ç½®æ¯”è‡ªå·±æƒé™æ›´é«˜çš„ç®¡ç†å‘˜å¯†ç  |
| `POST /admin/getRoleList` | `role_manage` | - |
| `POST /admin/getAllRoles` | `role_manage` | - |

### ç»Ÿè®¡æ¥å£
| æ¥å£è·¯å¾„ | æ‰€éœ€æƒé™ | é¢å¤–é™åˆ¶ |
|----------|----------|----------|
| `POST /stats/getDashboardStats` | `stats_view` | - |

## ğŸ› ï¸ å®ç°æœºåˆ¶

### 1. æƒé™ä¸­é—´ä»¶ (`common/auth.js`)

#### æ ¸å¿ƒå‡½æ•°
- `checkPermission(event, requiredPermissions)` - æƒé™éªŒè¯
- `requirePermission(handler, requiredPermissions)` - æƒé™è£…é¥°å™¨
- `logOperation(adminInfo, action, resource, details)` - æ“ä½œæ—¥å¿—

#### ä½¿ç”¨æ–¹å¼
```javascript
const { requirePermission } = require("./common/auth");

// åŸå§‹ä¸šåŠ¡å‡½æ•°
async function businessHandler(event, context) {
    // ä¸šåŠ¡é€»è¾‘
    // event.adminInfo åŒ…å«å½“å‰ç®¡ç†å‘˜ä¿¡æ¯
}

// å¯¼å‡ºå¸¦æƒé™æ ¡éªŒçš„å‡½æ•°
exports.main = requirePermission(businessHandler, 'required_permission');
```

### 2. TokenéªŒè¯æµç¨‹

1. **è·å–Token**: ä»è¯·æ±‚å¤´ `authorization: Bearer <token>` æˆ–å‚æ•° `token` è·å–
2. **éªŒè¯Token**: æŸ¥è¯¢æ•°æ®åº“éªŒè¯tokenæœ‰æ•ˆæ€§
3. **æ£€æŸ¥è¿‡æœŸ**: éªŒè¯tokenæ˜¯å¦è¿‡æœŸ
4. **è·å–æƒé™**: æŸ¥è¯¢ç®¡ç†å‘˜è§’è‰²å’Œæƒé™åˆ—è¡¨
5. **æƒé™åˆ¤æ–­**: æ£€æŸ¥æ˜¯å¦å…·æœ‰æ‰€éœ€æƒé™

### 3. æ“ä½œå®¡è®¡

æ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½ä¼šè®°å½•åˆ° `admin_operation_logs` è¡¨ï¼š

```javascript
{
    adminId: "ç®¡ç†å‘˜ID",
    username: "æ“ä½œè€…ç”¨æˆ·å", 
    action: "æ“ä½œç±»å‹ï¼ˆVIEW/CREATE/UPDATE/DELETE/BAN/UNBANï¼‰",
    resource: "æ“ä½œèµ„æºï¼ˆAPPS/USERS/LEADERBOARDSç­‰ï¼‰",
    details: "æ“ä½œè¯¦æƒ…ï¼ˆJSONå¯¹è±¡ï¼‰",
    severity: "æ“ä½œé£é™©ç­‰çº§ï¼ˆLOW/MEDIUM/HIGH/CRITICALï¼‰",
    createTime: "æ“ä½œæ—¶é—´"
}
```

## âš ï¸ å®‰å…¨æœ€ä½³å®è·µ

### 1. æƒé™åˆ†çº§
- **æŸ¥çœ‹æ“ä½œ**: åŸºç¡€æƒé™å³å¯
- **ä¿®æ”¹æ“ä½œ**: éœ€è¦å¯¹åº”ç®¡ç†æƒé™
- **åˆ é™¤æ“ä½œ**: éœ€è¦é«˜çº§è§’è‰²ï¼ˆç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜ï¼‰

### 2. æ•æ„Ÿæ“ä½œä¿æŠ¤
ä»¥ä¸‹æ“ä½œæœ‰é¢å¤–çš„è§’è‰²é™åˆ¶ï¼š
- åˆ é™¤åº”ç”¨ï¼šä»…è¶…çº§ç®¡ç†å‘˜
- åˆ é™¤ç”¨æˆ·ï¼šç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜
- åˆ é™¤æ’è¡Œæ¦œï¼šç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜

### 3. æ“ä½œæ—¥å¿—
- æ‰€æœ‰æ“ä½œéƒ½æœ‰è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
- åˆ é™¤ç­‰å…³é”®æ“ä½œæ ‡è®°ä¸º `CRITICAL` çº§åˆ«
- å°ç¦ç”¨æˆ·ç­‰æ“ä½œæ ‡è®°ä¸º `HIGH` çº§åˆ«

### 4. Tokenå®‰å…¨
- Tokenæœ‰è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼‰
- Tokenå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ”¯æŒæœåŠ¡ç«¯ä¸»åŠ¨å¤±æ•ˆ
- æ”¯æŒå¤šç«¯ç™»å½•ç®¡ç†

## ğŸš¨ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. éƒ¨ç½²å‰æ£€æŸ¥
- [ ] æ‰€æœ‰æ•æ„Ÿæ¥å£éƒ½å·²æ·»åŠ æƒé™æ ¡éªŒ
- [ ] åˆ é™¤æ“ä½œæœ‰é€‚å½“çš„è§’è‰²é™åˆ¶
- [ ] æ“ä½œæ—¥å¿—è®°å½•å®Œæ•´
- [ ] TokenéªŒè¯æœºåˆ¶æ­£å¸¸å·¥ä½œ

### 2. è¿è¥ç›‘æ§
- å®šæœŸæ£€æŸ¥æ“ä½œæ—¥å¿—ï¼Œç‰¹åˆ«æ˜¯ `CRITICAL` çº§åˆ«çš„æ“ä½œ
- ç›‘æ§å¼‚å¸¸çš„æƒé™å°è¯•
- å®šæœŸè½®æ¢è¶…çº§ç®¡ç†å‘˜å¯†ç 

### 3. ä»£ç å®¡æŸ¥
- æ–°å¢æ¥å£å¿…é¡»ç»è¿‡æƒé™è¯„ä¼°
- ç¡®ä¿å‰ç«¯æƒé™æ§åˆ¶ä¸åç«¯ä¸€è‡´
- é¿å…åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ç¡¬ç¼–ç æƒé™åˆ¤æ–­

## ğŸ“‹ æƒé™æµ‹è¯•æ¸…å•

### åŸºç¡€éªŒè¯
- [ ] æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—®ä»»ä½•ç®¡ç†æ¥å£
- [ ] è¿‡æœŸtokenä¼šè¢«æ­£ç¡®æ‹’ç»
- [ ] æ— æ•ˆtokenä¼šè¢«æ­£ç¡®æ‹’ç»

### æƒé™éªŒè¯
- [ ] ä¸åŒè§’è‰²åªèƒ½è®¿é—®å¯¹åº”æƒé™çš„æ¥å£
- [ ] è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ¥å£
- [ ] æƒé™ä¸è¶³æ—¶è¿”å›æ­£ç¡®çš„é”™è¯¯ç 

### æ“ä½œéªŒè¯
- [ ] åˆ é™¤æ“ä½œæœ‰æ­£ç¡®çš„è§’è‰²é™åˆ¶
- [ ] æ‰€æœ‰æ“ä½œéƒ½æœ‰å®¡è®¡æ—¥å¿—
- [ ] æ•æ„Ÿæ“ä½œæ ‡è®°äº†æ­£ç¡®çš„é£é™©ç­‰çº§

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§æƒé™é”™è¯¯
1. **4001 - ç¼ºå°‘è®¤è¯token**: æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®å‘é€token
2. **4001 - æ— æ•ˆtoken**: tokenå¯èƒ½è¿‡æœŸæˆ–è¢«åˆ é™¤
3. **4003 - æƒé™ä¸è¶³**: ç”¨æˆ·è§’è‰²æƒé™ä¸å¤Ÿ
4. **4003 - è§’è‰²é™åˆ¶**: ç‰¹æ®Šæ“ä½œéœ€è¦æ›´é«˜è§’è‰²

### è°ƒè¯•å»ºè®®
1. æ£€æŸ¥ `admin_users` è¡¨ä¸­çš„ç”¨æˆ·çŠ¶æ€å’Œè§’è‰²
2. æ£€æŸ¥ `admin_roles` è¡¨ä¸­çš„è§’è‰²æƒé™é…ç½®
3. æŸ¥çœ‹ `admin_operation_logs` è¡¨çš„å®¡è®¡è®°å½•
4. éªŒè¯APIè¯·æ±‚ä¸­çš„tokenæ ¼å¼å’Œå†…å®¹

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [APIæ¥å£æ–‡æ¡£](./API_INTERFACES.md)
- [éƒ¨ç½²æŒ‡å—](../game-web-admin/DEPLOYMENT.md)
- [å‰ç«¯æƒé™æ§åˆ¶](../game-web-admin/src/utils/auth.js) 