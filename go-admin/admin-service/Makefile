# =============================================================================
# Minigame Admin Service Makefile
# å¿«é€Ÿæ„å»ºå’Œéƒ¨ç½²å·¥å…·
# =============================================================================

# é¡¹ç›®é…ç½®
PROJECT_NAME := minigame-admin-service
VERSION ?= 1.0.0
BUILD_TIME := $(shell date '+%Y-%m-%d %H:%M:%S')
GIT_COMMIT := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# æ„å»ºæ ‡ç­¾
LDFLAGS := -X main.version=$(VERSION) -X 'main.buildTime=$(BUILD_TIME)' -X main.gitCommit=$(GIT_COMMIT)

# è·¯å¾„é…ç½®
BUILD_DIR := dist
RELEASE_DIR := release
BINARY_NAME := admin-service

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# =============================================================================
# å¸®åŠ©ä¿¡æ¯
# =============================================================================

.PHONY: help
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "Minigame Admin Service æ„å»ºå·¥å…·"
	@echo ""
	@echo "ä½¿ç”¨æ–¹æ³•:"
	@echo "  make <target>"
	@echo ""
	@echo "ç›®æ ‡:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make build          # æ„å»ºå½“å‰å¹³å°"
	@echo "  make build-all      # æ„å»ºæ‰€æœ‰å¹³å°"
	@echo "  make release        # åˆ›å»ºå‘å¸ƒåŒ…"
	@echo "  make install        # å®‰è£…åˆ°æœ¬åœ°"

# =============================================================================
# å¼€å‘å·¥å…·
# =============================================================================

.PHONY: deps
deps: ## å®‰è£…ä¾èµ–
	@echo "ğŸ”„ å®‰è£…Goä¾èµ–..."
	@go mod tidy
	@go mod download
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

.PHONY: test
test: ## è¿è¡Œæµ‹è¯•
	@echo "ğŸ”„ è¿è¡Œæµ‹è¯•..."
	@go test -v ./...
	@echo "âœ… æµ‹è¯•å®Œæˆ"

.PHONY: fmt
fmt: ## æ ¼å¼åŒ–ä»£ç 
	@echo "ğŸ”„ æ ¼å¼åŒ–ä»£ç ..."
	@go fmt ./...
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

.PHONY: lint
lint: ## ä»£ç æ£€æŸ¥
	@echo "ğŸ”„ ä»£ç æ£€æŸ¥..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint æœªå®‰è£…ï¼Œè·³è¿‡æ£€æŸ¥"; \
		go vet ./...; \
	fi
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

.PHONY: clean
clean: ## æ¸…ç†æ„å»ºæ–‡ä»¶
	@echo "ğŸ”„ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf $(BUILD_DIR) $(RELEASE_DIR) bin/
	@echo "âœ… æ¸…ç†å®Œæˆ"

# =============================================================================
# æ„å»ºç›®æ ‡
# =============================================================================

.PHONY: build
build: deps ## æ„å»ºå½“å‰å¹³å°
	@echo "ğŸ”„ æ„å»º $(PROJECT_NAME)..."
	@mkdir -p bin
	@go build -ldflags "$(LDFLAGS)" -o bin/$(BINARY_NAME) .
	@echo "âœ… æ„å»ºå®Œæˆ: bin/$(BINARY_NAME)"

.PHONY: build-linux
build-linux: deps ## æ„å»ºLinuxç‰ˆæœ¬
	@echo "ğŸ”„ æ„å»ºLinuxç‰ˆæœ¬..."
	@mkdir -p $(BUILD_DIR)/linux-amd64
	@GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "$(LDFLAGS)" -o $(BUILD_DIR)/linux-amd64/$(BINARY_NAME) .
	@cp -r conf views static $(BUILD_DIR)/linux-amd64/ 2>/dev/null || true
	@echo "âœ… Linuxç‰ˆæœ¬æ„å»ºå®Œæˆ"

.PHONY: build-windows
build-windows: deps ## æ„å»ºWindowsç‰ˆæœ¬
	@echo "ğŸ”„ æ„å»ºWindowsç‰ˆæœ¬..."
	@mkdir -p $(BUILD_DIR)/windows-amd64
	@GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "$(LDFLAGS)" -o $(BUILD_DIR)/windows-amd64/$(BINARY_NAME).exe .
	@cp -r conf views static $(BUILD_DIR)/windows-amd64/ 2>/dev/null || true
	@echo "âœ… Windowsç‰ˆæœ¬æ„å»ºå®Œæˆ"

.PHONY: build-darwin
build-darwin: deps ## æ„å»ºmacOSç‰ˆæœ¬
	@echo "ğŸ”„ æ„å»ºmacOSç‰ˆæœ¬..."
	@mkdir -p $(BUILD_DIR)/darwin-amd64
	@GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "$(LDFLAGS)" -o $(BUILD_DIR)/darwin-amd64/$(BINARY_NAME) .
	@cp -r conf views static $(BUILD_DIR)/darwin-amd64/ 2>/dev/null || true
	@echo "âœ… macOSç‰ˆæœ¬æ„å»ºå®Œæˆ"

.PHONY: build-all
build-all: build-linux build-windows build-darwin ## æ„å»ºæ‰€æœ‰å¹³å°
	@echo "ğŸ‰ æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ"

# =============================================================================
# å‰ç«¯æ„å»º
# =============================================================================

.PHONY: build-frontend
build-frontend: ## æ„å»ºå‰ç«¯é¡¹ç›®
	@echo "ğŸ”„ æ„å»ºå‰ç«¯é¡¹ç›®..."
	@if [ -d "../game-admin" ]; then \
		cd ../game-admin && \
		if [ -f "package.json" ]; then \
			if command -v yarn >/dev/null 2>&1; then \
				yarn install && yarn build; \
			else \
				npm install && npm run build; \
			fi && \
			mkdir -p ../admin-service/$(BUILD_DIR)/frontend && \
			cp -r dist/* ../admin-service/$(BUILD_DIR)/frontend/; \
		else \
			echo "âš ï¸  æœªæ‰¾åˆ°package.jsonï¼Œè·³è¿‡å‰ç«¯æ„å»º"; \
		fi \
	else \
		echo "âš ï¸  å‰ç«¯ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å‰ç«¯æ„å»º"; \
	fi
	@echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

# =============================================================================
# å‘å¸ƒå’Œéƒ¨ç½²
# =============================================================================

.PHONY: release
release: clean build-all build-frontend ## åˆ›å»ºå‘å¸ƒåŒ…
	@echo "ğŸ”„ åˆ›å»ºå‘å¸ƒåŒ…..."
	@mkdir -p $(RELEASE_DIR)
	@for platform in linux-amd64 windows-amd64 darwin-amd64; do \
		if [ -d "$(BUILD_DIR)/$$platform" ]; then \
			release_name="$(PROJECT_NAME)-$(VERSION)-$$platform"; \
			echo "ğŸ“¦ åˆ›å»º $$release_name"; \
			mkdir -p "$(RELEASE_DIR)/$$release_name"; \
			cp -r "$(BUILD_DIR)/$$platform"/* "$(RELEASE_DIR)/$$release_name/"; \
			if [ -d "$(BUILD_DIR)/frontend" ]; then \
				mkdir -p "$(RELEASE_DIR)/$$release_name/static/admin"; \
				cp -r "$(BUILD_DIR)/frontend"/* "$(RELEASE_DIR)/$$release_name/static/admin/"; \
			fi; \
			cp install.sh install.bat "$(RELEASE_DIR)/$$release_name/" 2>/dev/null || true; \
			echo "# $(PROJECT_NAME) $(VERSION)" > "$(RELEASE_DIR)/$$release_name/README.md"; \
			echo "" >> "$(RELEASE_DIR)/$$release_name/README.md"; \
			echo "æ„å»ºæ—¶é—´: $(BUILD_TIME)" >> "$(RELEASE_DIR)/$$release_name/README.md"; \
			echo "Gitæäº¤: $(GIT_COMMIT)" >> "$(RELEASE_DIR)/$$release_name/README.md"; \
			echo "å¹³å°: $$platform" >> "$(RELEASE_DIR)/$$release_name/README.md"; \
			cd $(RELEASE_DIR) && tar -czf "$$release_name.tar.gz" "$$release_name/" && cd ..; \
		fi \
	done
	@echo "ğŸ‰ å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"

.PHONY: install
install: build ## å®‰è£…åˆ°æœ¬åœ°
	@echo "ğŸ”„ å®‰è£…åˆ°æœ¬åœ°..."
	@sudo cp bin/$(BINARY_NAME) /usr/local/bin/
	@echo "âœ… å®‰è£…å®Œæˆ: /usr/local/bin/$(BINARY_NAME)"

# =============================================================================
# è¿è¡Œå’Œè°ƒè¯•
# =============================================================================

.PHONY: run
run: build ## è¿è¡ŒæœåŠ¡
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
	@./bin/$(BINARY_NAME)

.PHONY: dev
dev: ## å¼€å‘æ¨¡å¼è¿è¡Œ
	@echo "ğŸ”§ å¼€å‘æ¨¡å¼å¯åŠ¨..."
	@go run . -dev

.PHONY: debug
debug: ## è°ƒè¯•æ¨¡å¼è¿è¡Œ
	@echo "ğŸ› è°ƒè¯•æ¨¡å¼å¯åŠ¨..."
	@dlv debug --headless --listen=:2345 --api-version=2 --accept-multiclient

# =============================================================================
# éƒ¨ç½²ç›¸å…³
# =============================================================================

.PHONY: deploy-install
deploy-install: ## è¿è¡Œå®‰è£…è„šæœ¬
	@echo "ğŸ”„ è¿è¡Œå®‰è£…è„šæœ¬..."
	@if [ -f "install.sh" ]; then \
		chmod +x install.sh && ./install.sh; \
	else \
		echo "âŒ å®‰è£…è„šæœ¬ä¸å­˜åœ¨"; \
	fi

.PHONY: docker-build
docker-build: ## æ„å»ºDockeré•œåƒ
	@echo "ğŸ”„ æ„å»ºDockeré•œåƒ..."
	@if [ -f "Dockerfile" ]; then \
		docker build -t $(PROJECT_NAME):$(VERSION) .; \
		docker tag $(PROJECT_NAME):$(VERSION) $(PROJECT_NAME):latest; \
	else \
		echo "âš ï¸  Dockerfileä¸å­˜åœ¨ï¼Œè·³è¿‡Dockeræ„å»º"; \
	fi
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"

# =============================================================================
# ä¿¡æ¯æ˜¾ç¤º
# =============================================================================

.PHONY: info
info: ## æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
	@echo "ğŸ“‹ é¡¹ç›®ä¿¡æ¯:"
	@echo "â”œâ”€â”€ é¡¹ç›®åç§°: $(PROJECT_NAME)"
	@echo "â”œâ”€â”€ ç‰ˆæœ¬: $(VERSION)"
	@echo "â”œâ”€â”€ æ„å»ºæ—¶é—´: $(BUILD_TIME)"
	@echo "â”œâ”€â”€ Gitæäº¤: $(GIT_COMMIT)"
	@echo "â”œâ”€â”€ Goç‰ˆæœ¬: $(shell go version | awk '{print $$3}')"
	@echo "â””â”€â”€ æ„å»ºæ ‡ç­¾: $(LDFLAGS)"
	@echo ""

.PHONY: status
status: ## æ£€æŸ¥æ„å»ºçŠ¶æ€
	@echo "ğŸ“Š æ„å»ºçŠ¶æ€:"
	@if [ -d "bin" ]; then \
		echo "â”œâ”€â”€ æœ¬åœ°æ„å»º: âœ…"; \
		ls -la bin/; \
	else \
		echo "â”œâ”€â”€ æœ¬åœ°æ„å»º: âŒ"; \
	fi
	@if [ -d "$(BUILD_DIR)" ]; then \
		echo "â”œâ”€â”€ å¤šå¹³å°æ„å»º: âœ…"; \
		ls -la $(BUILD_DIR)/; \
	else \
		echo "â”œâ”€â”€ å¤šå¹³å°æ„å»º: âŒ"; \
	fi
	@if [ -d "$(RELEASE_DIR)" ]; then \
		echo "â””â”€â”€ å‘å¸ƒåŒ…: âœ…"; \
		ls -la $(RELEASE_DIR)/; \
	else \
		echo "â””â”€â”€ å‘å¸ƒåŒ…: âŒ"; \
	fi
	@echo ""
