# 数据迁移方案

## 迁移概述

### 迁移目标
将现有的MongoDB数据完整迁移到MySQL，确保数据一致性和业务连续性。

### 迁移策略
1. **分阶段迁移**：先迁移系统数据，再迁移业务数据
2. **双写验证**：迁移期间同时写入新旧系统，验证数据一致性
3. **回滚准备**：保留原数据，确保可以快速回滚
4. **增量同步**：支持迁移过程中的增量数据同步

## 数据类型映射

### MongoDB到MySQL类型映射表

| MongoDB类型 | MySQL类型 | 说明 |
|------------|-----------|------|
| ObjectId | VARCHAR(64) | 使用字符串存储，保持原有ID |
| String | VARCHAR/TEXT | 根据长度选择合适类型 |
| Number | BIGINT/DECIMAL | 整数用BIGINT，小数用DECIMAL |
| Boolean | BOOLEAN | 直接映射 |
| Date | DATETIME | 时间格式转换 |
| Object/Array | JSON | 使用MySQL的JSON类型 |
| null | NULL | 直接映射 |

### 特殊字段处理

```javascript
// MongoDB文档示例
{
    "_id": ObjectId("507f1f77bcf86cd799439011"),
    "CreatedAt": "2023-10-01 10:00:00",
    "gmtModify": "2023-10-01 15:30:00"
}

// 转换为MySQL
{
    "id": "507f1f77bcf86cd799439011",
    "create_time": "2023-10-01 10:00:00",
    "update_time": "2023-10-01 15:30:00"
}
```

## 迁移工具设计

### 工具架构
```
MongoDB → 迁移工具 → MySQL
    ↓         ↓         ↓
  读取数据  → 转换格式 → 写入数据
    ↓         ↓         ↓
  验证完整性 → 错误处理 → 结果报告
```

### 核心功能模块

#### 1. 数据读取模块
- 连接MongoDB数据库
- 批量读取文档数据
- 处理大数据集分页
- 异常重试机制

#### 2. 数据转换模块
- 字段类型转换
- 数据格式标准化
- 特殊字符处理
- JSON数据验证

#### 3. 数据写入模块
- MySQL连接池管理
- 批量插入优化
- 事务控制
- 冲突处理策略

#### 4. 验证模块
- 数据完整性检查
- 记录数对比
- 抽样数据验证
- 迁移报告生成

## 具体迁移步骤

### 第一阶段：系统数据迁移

#### 1. 管理员数据迁移
```sql
-- 源集合：admin_users
-- 目标表：admin_users

INSERT INTO admin_users (
    id, username, password, nickname, role, email, phone,
    status, token, token_expire, last_login_time, 
    create_time, update_time
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
```

#### 2. 角色数据迁移
```sql
-- 源集合：admin_roles  
-- 目标表：admin_roles

INSERT INTO admin_roles (
    id, role_name, role_description, permissions,
    create_time, update_time
) VALUES (?, ?, ?, ?, ?, ?);
```

#### 3. 操作日志迁移
```sql
-- 源集合：admin_operation_logs
-- 目标表：admin_operation_logs

INSERT INTO admin_operation_logs (
    id, admin_id, username, action, resource, details, create_time
) VALUES (?, ?, ?, ?, ?, ?, ?);
```

### 第二阶段：应用数据迁移

#### 1. 应用信息迁移
```sql
-- 源集合：applications 或从云函数配置中提取
-- 目标表：applications

INSERT INTO applications (
    id, app_id, app_name, app_description, platform, 
    app_key, status, create_time, update_time
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?);
```

#### 2. 游戏配置迁移
```sql
-- 源集合：game_config
-- 目标表：game_config

INSERT INTO game_config (
    id, app_id, config_key, config_value, version,
    description, config_type, is_active, create_time, update_time
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
```

### 第三阶段：业务数据迁移

#### 1. 用户数据迁移
```javascript
// 迁移逻辑伪代码
for each app_id {
    // 动态创建用户表
    CREATE TABLE user_{app_id} IF NOT EXISTS;
    
    // 迁移用户数据
    MongoDB: user_{app_id} → MySQL: user_{app_id}
    
    // 数据转换
    {
        "_id": ObjectId,
        "playerId": String,
        "data": String, // JSON字符串
        "CreatedAt": Date,
        "gmtModify": Date
    }
    ↓
    {
        "id": AUTO_INCREMENT,
        "player_id": String,
        "data": LONGTEXT,
        "create_time": DATETIME,
        "update_time": DATETIME  
    }
}
```

#### 2. 排行榜数据迁移
```javascript
// 每个应用的排行榜数据
for each app_id {
    CREATE TABLE leaderboard_{app_id} IF NOT EXISTS;
    
    // 迁移排行榜记录
    MongoDB: leaderboard_{app_id} → MySQL: leaderboard_{app_id}
}
```

#### 3. 计数器数据迁移
```javascript
// 每个应用的计数器数据
for each app_id {
    CREATE TABLE counter_{app_id} IF NOT EXISTS;
    
    // 迁移计数器记录，注意处理重置时间计算
    MongoDB: counter_{app_id} → MySQL: counter_{app_id}
}
```

#### 4. 邮件数据迁移
```javascript
// 每个应用的邮件数据
for each app_id {
    CREATE TABLE mail_{app_id} IF NOT EXISTS;
    
    // 迁移邮件记录，处理奖励JSON格式
    MongoDB: mail_{app_id} → MySQL: mail_{app_id}
}
```

## 迁移工具实现

### 配置文件示例
```yaml
# migration-config.yaml
source:
  type: mongodb
  connection: "mongodb://username:password@host:port/database"
  
target:
  type: mysql
  connection: "root:password@tcp(localhost:3306)/gamedb?charset=utf8mb4&parseTime=True&loc=Local"
  
settings:
  batch_size: 1000        # 批处理大小
  worker_count: 4         # 并发工作线程数
  retry_count: 3          # 失败重试次数
  verify_data: true       # 是否验证数据一致性
  
collections:
  # 系统表迁移配置
  - source: "admin_users"
    target: "admin_users"
    primary_key: "_id"
    
  - source: "admin_roles"
    target: "admin_roles"
    primary_key: "_id"
    
  # 动态表迁移配置  
  - source_pattern: "user_*"
    target_pattern: "user_*"
    dynamic: true
    
  - source_pattern: "leaderboard_*"
    target_pattern: "leaderboard_*"
    dynamic: true
```

### 迁移命令示例
```bash
# 全量迁移
./migration-tool --config migration-config.yaml --mode full

# 增量迁移
./migration-tool --config migration-config.yaml --mode incremental --since "2023-10-01 00:00:00"

# 验证数据
./migration-tool --config migration-config.yaml --mode verify

# 生成报告
./migration-tool --config migration-config.yaml --mode report
```

## 数据验证方案

### 1. 记录数验证
```sql
-- 验证总记录数是否一致
SELECT 
    'admin_users' as table_name,
    (SELECT COUNT(*) FROM admin_users) as mysql_count,
    -- MongoDB记录数需要从迁移日志中获取
    ? as mongo_count;
```

### 2. 抽样数据验证
- 随机抽取5%的数据进行详细对比
- 验证关键字段的数据一致性
- 检查JSON字段的格式正确性

### 3. 业务逻辑验证
- 验证排行榜排序结果一致性
- 验证计数器数值正确性
- 验证用户数据可正常解析

## 风险控制

### 1. 备份策略
- 迁移前完整备份MongoDB数据
- 迁移过程中保留MySQL快照
- 关键节点创建检查点

### 2. 回滚方案
- 保持MongoDB数据不变，直到验证完成
- 提供快速回滚脚本
- 明确回滚决策点和触发条件

### 3. 性能优化
- 使用批量插入减少网络开销
- 合理设置MySQL参数优化写入性能
- 监控迁移过程中的系统资源使用

### 4. 异常处理
- 网络中断自动重连
- 数据格式异常跳过并记录
- 主键冲突处理策略
- 详细的错误日志记录

## 迁移时间估算

### 数据量评估
| 数据类型 | 预估记录数 | 单条记录大小 | 预估迁移时间 |
|---------|-----------|-------------|-------------|
| 管理员数据 | 100 | 1KB | 1分钟 |
| 用户数据 | 100万 | 2KB | 2小时 |
| 排行榜数据 | 500万 | 1KB | 3小时 |
| 计数器数据 | 10万 | 0.5KB | 30分钟 |
| 邮件数据 | 50万 | 1KB | 1小时 |
| **总计** | **约560万** | **平均1.5KB** | **约7小时** |

### 迁移窗口建议
- **推荐时间**：凌晨2:00-6:00（业务低峰期）
- **预留时间**：8小时（包含验证和应急处理时间）
- **备用窗口**：周末或节假日

## 迁移成功标准

### 数据完整性
- ✅ 所有集合/表记录数100%一致
- ✅ 关键业务数据抽样验证通过率≥99.9%
- ✅ 数据类型转换准确率100%

### 功能完整性  
- ✅ 所有API接口功能正常
- ✅ 管理后台功能完整可用
- ✅ SDK接入验证通过

### 性能指标
- ✅ API响应时间不超过原系统1.5倍
- ✅ 数据库查询性能满足业务需求
- ✅ 系统稳定性测试通过

这个迁移方案确保了数据的完整性和系统的稳定性，同时提供了完善的风险控制措施。 